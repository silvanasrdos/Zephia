<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Sistema de mensajería para docentes y escuelas">
    <meta name="theme-color" content="#8b4513">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Zephia">
    <title>Zephia - Sistema de Mensajería - Usuario</title>
    <link rel="icon" type="image/png" href="img/logo.png">
    <link rel="apple-touch-icon" href="img/logo.png">
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="admin-container">
        <!-- Barra lateral izquierda -->
        <div class="sidebar">
            <!-- Header de la barra lateral -->
            <div class="sidebar-header">
                <div class="profile-section">
                    <div class="profile-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="profile-info">
                        <h3 id="user-name">Usuario</h3>
                        <span class="status" id="user-type">Docente</span>
                    </div>
                </div>
                <div class="header-actions">
                    <button class="action-btn" title="Configuración" onclick="openSettingsModal()">
                        <i class="fas fa-cog"></i>
                    </button>
                    <button class="action-btn" title="Cerrar sesión" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>

            <!-- Menú de navegación (solo mensajería) -->
            <div class="nav-menu">
                <div class="nav-item active" data-section="messaging">
                    <i class="fas fa-comments"></i>
                    <span>Mensajería</span>
                </div>
            </div>
        </div>

        <!-- Área principal del contenido -->
        <div class="main-content">
            <!-- Header del contenido -->
            <div class="content-header">
                <div class="breadcrumb">
                    <h2>Sistema de Mensajería</h2>
                    <p id="user-description">Comunicación con administradores y otras escuelas/docentes</p>
                </div>
                <div class="header-actions">
                    <button class="action-btn" onclick="openNewMessageModal()">
                        <i class="fas fa-plus"></i>
                        <span>Nuevo Mensaje</span>
                    </button>
                </div>
            </div>

            <!-- Contenido del sistema de mensajería -->
            <div class="content-body">
                <div id="messaging-section" class="content-section active">
                    <div class="messaging-container">
                        <!-- Panel izquierdo - Lista de conversaciones -->
                        <div class="conversations-panel">
                            <div class="conversations-header">
                                <h3>Conversaciones</h3>
                            </div>
                            
                            <!-- Filtros de búsqueda -->
                            <div class="search-filters">
                                <div class="filter-group">
                                    <label>Filtrar por tipo:</label>
                                    <select id="filter-type" onchange="filterConversations()">
                                        <option value="all">Todos</option>
                                        <option value="admin">Administradores</option>
                                        <option value="school">Escuelas</option>
                                        <option value="teacher">Docentes</option>
                                    </select>
                                </div>
                                <div class="filter-group">
                                    <label>Buscar:</label>
                                    <input type="text" id="search-conversations" placeholder="Buscar conversaciones..." onkeyup="searchConversations()">
                                </div>
                            </div>
                            
                            <!-- Lista de conversaciones -->
                            <div class="conversations-list" id="conversations-list">
                                <!-- Las conversaciones se cargarán dinámicamente -->
                            </div>
                        </div>

                        <!-- Panel derecho - Área de chat -->
                        <div class="chat-panel">
                            <!-- Mensaje de bienvenida -->
                            <div class="welcome-message" id="welcome-message">
                                <div class="welcome-icon">
                                    <i class="fas fa-comments"></i>
                                </div>
                                <h3>Bienvenido al Sistema de Mensajería</h3>
                                <p>Selecciona una conversación para comenzar a chatear con administradores, otras escuelas o docentes.</p>
                            </div>

                            <!-- Chat activo (se muestra cuando hay una conversación seleccionada) -->
                            <div id="active-chat" style="display: none;">
                                <div class="chat-header">
                                    <div class="chat-contact-info">
                                        <div class="contact-avatar">
                                            <i class="fas fa-user"></i>
                                        </div>
                                        <div class="contact-details">
                                            <h3 id="chat-contact-name">Contacto</h3>
                                            <span class="contact-status" id="chat-contact-status">En línea</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Contenedor de mensajes -->
                                <div class="messages-container" id="messages-container">
                                    <!-- Los mensajes se cargarán dinámicamente -->
                                </div>
                                
                                <!-- Área de entrada de mensaje -->
                                <div class="message-input-container">
                                    <div class="input-actions">
                                        <button class="btn-icon" title="Adjuntar archivo">
                                            <i class="fas fa-paperclip"></i>
                                        </button>
                                        <div class="priority-selector">
                                            <label title="Prioridad del mensaje">
                                                <i class="fas fa-flag"></i>
                                                <select id="chat-message-priority" onchange="updatePriorityIndicator()">
                                                    <option value="baja">Baja</option>
                                                    <option value="media">Media</option>
                                                    <option value="alta">Alta</option>
                                                </select>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="message-input-wrapper">
                                        <input type="text" class="message-input" id="message-input" placeholder="Escribe tu mensaje..." onkeypress="handleMessageKeyPress(event)">
                                    </div>
                                    <button class="btn-primary" onclick="sendMessage()">
                                        <i class="fas fa-paper-plane"></i>
                                        Enviar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para nuevo mensaje -->
    <div id="newMessageModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Nueva Conversación</h3>
                <button class="close-btn" onclick="closeNewMessageModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="newMessageForm">
                <div class="form-group">
                    <label>Tipo de destinatario:</label>
                    <select id="recipient-type" required onchange="loadRecipients()">
                        <option value="">Seleccionar tipo</option>
                        <option value="admin">Administrador</option>
                        <option value="school">Escuela</option>
                        <option value="teacher">Docente</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Destinatario:</label>
                    <select id="recipient-select" required disabled>
                        <option value="">Primero selecciona el tipo</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Asunto:</label>
                    <input type="text" id="message-subject" placeholder="Asunto del mensaje" required>
                </div>
                
                <div class="form-group">
                    <label>Mensaje:</label>
                    <textarea id="message-content" rows="4" placeholder="Escribe tu mensaje..." required></textarea>
                </div>
                
                <div class="form-group">
                    <label>Prioridad del mensaje:</label>
                    <div class="priority-options">
                        <label class="priority-option">
                            <input type="radio" name="message-priority" value="baja" checked>
                            <span class="priority-badge priority-baja">Baja</span>
                        </label>
                        <label class="priority-option">
                            <input type="radio" name="message-priority" value="media">
                            <span class="priority-badge priority-media">Media</span>
                        </label>
                        <label class="priority-option">
                            <input type="radio" name="message-priority" value="alta">
                            <span class="priority-badge priority-alta">Alta</span>
                        </label>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn-secondary" onclick="closeNewMessageModal()">Cancelar</button>
                    <button type="submit" class="btn-primary">Iniciar Conversación</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de configuración -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Configuración de Usuario</h3>
                <button class="close-btn" onclick="closeSettingsModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="settingsForm">
                <div class="form-group">
                    <label>Nombre completo:</label>
                    <input type="text" id="settings-name" required>
                </div>
                
                <div class="form-group">
                    <label>Correo electrónico:</label>
                    <input type="email" id="settings-email" required>
                </div>
                
                <div class="form-group">
                    <label>Institución:</label>
                    <input type="text" id="settings-institution" required>
                </div>
                
                <div class="form-group">
                    <label>Cambiar contraseña:</label>
                    <div class="password-input-wrapper">
                        <input type="password" id="settings-password" placeholder="Nueva contraseña (dejar en blanco para no cambiar)">
                        <button type="button" class="toggle-password-btn" onclick="togglePassword('settings-password')">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn-secondary" onclick="closeSettingsModal()">Cancelar</button>
                    <button type="submit" class="btn-primary">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Datos del usuario (en un sistema real esto vendría del servidor)
        let currentUser = {
            id: 1,
            name: 'María González',
            type: 'Docente',
            institution: 'Escuela Primaria San José',
            email: 'maria.gonzalez@escuela.edu'
        };

        // Conversaciones de ejemplo
        let conversations = [
            {
                id: 1,
                name: 'Administrador del Sistema',
                type: 'admin',
                lastMessage: 'Hola, ¿cómo va todo en la escuela?',
                time: '10:30',
                unread: 0,
                priority: 'baja'
            },
            {
                id: 2,
                name: 'Escuela Secundaria Los Pinos',
                type: 'school',
                lastMessage: 'Nos gustaría coordinar una actividad conjunta',
                time: 'Ayer',
                unread: 2,
                priority: 'media'
            },
            {
                id: 3,
                name: 'Prof. Carlos Mendoza',
                type: 'teacher',
                lastMessage: '¿Podemos compartir recursos educativos?',
                time: 'Lun',
                unread: 0,
                priority: 'baja'
            }
        ];

        let activeConversation = null;
        let messages = {};

        // Inicialización
        document.addEventListener('DOMContentLoaded', function() {
            loadUserInfo();
            loadConversations();
            loadMessages();
            updatePriorityIndicator(); // Inicializar indicador de prioridad
        });

        // Cargar información del usuario
        function loadUserInfo() {
            document.getElementById('user-name').textContent = currentUser.name;
            document.getElementById('user-type').textContent = currentUser.type;
            document.getElementById('user-description').textContent = `Comunicación como ${currentUser.type.toLowerCase()} de ${currentUser.institution}`;
            
            // Cargar datos en el modal de configuración
            document.getElementById('settings-name').value = currentUser.name;
            document.getElementById('settings-email').value = currentUser.email;
            document.getElementById('settings-institution').value = currentUser.institution;
        }

        // Cargar conversaciones
        function loadConversations() {
            const container = document.getElementById('conversations-list');
            container.innerHTML = '';
            
            conversations.forEach(conv => {
                const convElement = createConversationElement(conv);
                container.appendChild(convElement);
            });
        }

        // Crear elemento de conversación
        function createConversationElement(conv) {
            const div = document.createElement('div');
            div.className = 'conversation-item';
            div.setAttribute('data-priority', conv.priority);
            div.onclick = () => selectConversation(conv);
            
            const iconClass = conv.type === 'admin' ? 'fa-user-shield' : 
                            conv.type === 'school' ? 'fa-school' : 'fa-chalkboard-teacher';
            
            div.innerHTML = `
                <div class="conversation-avatar">
                    <i class="fas ${iconClass}"></i>
                </div>
                <div class="conversation-info">
                    <div class="conversation-header">
                        <h4>${conv.name}</h4>
                        <span class="conversation-time">${conv.time}</span>
                    </div>
                    <div class="conversation-meta">
                        <span class="priority-badge priority-${conv.priority}">${conv.priority}</span>
                        <span class="conversation-subject">${conv.type === 'admin' ? 'Administrador' : conv.type === 'school' ? 'Escuela' : 'Docente'}</span>
                    </div>
                    <p class="conversation-preview">${conv.lastMessage}</p>
                </div>
                ${conv.unread > 0 ? `<div class="unread-badge">${conv.unread}</div>` : ''}
            `;
            
            return div;
        }

        // Seleccionar conversación
        function selectConversation(conv) {
            activeConversation = conv;
            
            // Actualizar UI
            document.querySelectorAll('.conversation-item').forEach(item => item.classList.remove('active'));
            event.currentTarget.classList.add('active');
            
            // Mostrar chat
            document.getElementById('welcome-message').style.display = 'none';
            document.getElementById('active-chat').style.display = 'flex';
            document.getElementById('active-chat').style.flexDirection = 'column';
            
            // Actualizar información del contacto
            document.getElementById('chat-contact-name').textContent = conv.name;
            document.getElementById('chat-contact-status').textContent = conv.type === 'admin' ? 'Administrador' : 'En línea';
            
            // Cargar mensajes
            loadChatMessages(conv.id);
        }

        // Cargar mensajes del chat
        function loadChatMessages(conversationId) {
            const container = document.getElementById('messages-container');
            container.innerHTML = '';
            
            if (!messages[conversationId]) {
                messages[conversationId] = [
                    {
                        id: 1,
                        text: 'Hola, ¿en qué puedo ayudarte?',
                        time: '10:30',
                        sender: 'them',
                        type: 'received'
                    }
                ];
            }
            
            messages[conversationId].forEach(msg => {
                const msgElement = createMessageElement(msg);
                container.appendChild(msgElement);
            });
            
            container.scrollTop = container.scrollHeight;
        }

        // Crear elemento de mensaje
        function createMessageElement(msg) {
            const div = document.createElement('div');
            div.className = `message ${msg.type}`;
            
            // Mostrar prioridad solo para mensajes enviados por el usuario
            const priorityBadge = msg.priority && msg.type === 'sent' ? 
                `<span class="message-priority priority-${msg.priority}">${msg.priority}</span>` : '';
            
            div.innerHTML = `
                <div class="message-content">
                    <p>${msg.text}</p>
                    <div class="message-footer">
                        ${priorityBadge}
                        <span class="message-time">${msg.time}</span>
                    </div>
                </div>
            `;
            
            return div;
        }

        // Enviar mensaje
        function sendMessage() {
            const input = document.getElementById('message-input');
            const text = input.value.trim();
            
            if (!text || !activeConversation) return;
            
            // Obtener la prioridad seleccionada
            const priority = document.getElementById('chat-message-priority').value;
            
            const newMessage = {
                id: Date.now(),
                text: text,
                time: new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' }),
                sender: 'me',
                type: 'sent',
                priority: priority
            };
            
            // Agregar mensaje a la conversación
            if (!messages[activeConversation.id]) {
                messages[activeConversation.id] = [];
            }
            messages[activeConversation.id].push(newMessage);
            
            // Actualizar UI
            const container = document.getElementById('messages-container');
            const msgElement = createMessageElement(newMessage);
            container.appendChild(msgElement);
            container.scrollTop = container.scrollHeight;
            
            // Limpiar input
            input.value = '';
            
            // Simular respuesta automática
            setTimeout(() => {
                const autoReply = {
                    id: Date.now() + 1,
                    text: 'Mensaje recibido. Te responderemos pronto.',
                    time: new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' }),
                    sender: 'them',
                    type: 'received'
                };
                
                messages[activeConversation.id].push(autoReply);
                const replyElement = createMessageElement(autoReply);
                container.appendChild(replyElement);
                container.scrollTop = container.scrollHeight;
            }, 1000);
        }

        // Manejar tecla Enter en el input
        function handleMessageKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // Filtrar conversaciones
        function filterConversations() {
            const filterType = document.getElementById('filter-type').value;
            const searchTerm = document.getElementById('search-conversations').value.toLowerCase();
            
            const filtered = conversations.filter(conv => {
                const typeMatch = filterType === 'all' || conv.type === filterType;
                const searchMatch = conv.name.toLowerCase().includes(searchTerm) || 
                                  conv.lastMessage.toLowerCase().includes(searchTerm);
                return typeMatch && searchMatch;
            });
            
            const container = document.getElementById('conversations-list');
            container.innerHTML = '';
            
            filtered.forEach(conv => {
                const convElement = createConversationElement(conv);
                container.appendChild(convElement);
            });
        }

        // Buscar conversaciones
        function searchConversations() {
            filterConversations();
        }

        // Cargar mensajes iniciales
        function loadMessages() {
            // Simular mensajes existentes
            messages[1] = [
                {
                    id: 1,
                    text: 'Hola, ¿cómo va todo en la escuela?',
                    time: '10:30',
                    sender: 'them',
                    type: 'received'
                },
                {
                    id: 2,
                    text: 'Todo bien, gracias por preguntar. ¿Hay alguna novedad?',
                    time: '10:32',
                    sender: 'me',
                    type: 'sent'
                }
            ];
        }

        // Modal de nuevo mensaje
        function openNewMessageModal() {
            document.getElementById('newMessageModal').style.display = 'flex';
        }

        function closeNewMessageModal() {
            document.getElementById('newMessageModal').style.display = 'none';
            document.getElementById('newMessageForm').reset();
            document.getElementById('recipient-select').disabled = true;
        }

        // Cargar destinatarios según el tipo
        function loadRecipients() {
            const type = document.getElementById('recipient-type').value;
            const select = document.getElementById('recipient-select');
            
            select.innerHTML = '<option value="">Seleccionar destinatario</option>';
            select.disabled = !type;
            
            if (type) {
                let recipients = [];
                
                if (type === 'admin') {
                    recipients = [
                        { id: 1, name: 'Administrador Principal' },
                        { id: 2, name: 'Administrador de Soporte' }
                    ];
                } else if (type === 'school') {
                    recipients = [
                        { id: 3, name: 'Escuela Secundaria Los Pinos' },
                        { id: 4, name: 'Escuela Primaria San Martín' },
                        { id: 5, name: 'Instituto Técnico Industrial' }
                    ];
                } else if (type === 'teacher') {
                    recipients = [
                        { id: 6, name: 'Prof. Carlos Mendoza' },
                        { id: 7, name: 'Prof. Ana Silva' },
                        { id: 8, name: 'Prof. Roberto Torres' }
                    ];
                }
                
                recipients.forEach(recipient => {
                    const option = document.createElement('option');
                    option.value = recipient.id;
                    option.textContent = recipient.name;
                    select.appendChild(option);
                });
            }
        }

        // Enviar nuevo mensaje
        document.getElementById('newMessageForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const type = document.getElementById('recipient-type').value;
            const recipientId = document.getElementById('recipient-select').value;
            const subject = document.getElementById('message-subject').value;
            const content = document.getElementById('message-content').value;
            const priority = document.querySelector('input[name="message-priority"]:checked').value;
            
            if (!type || !recipientId || !subject || !content) {
                alert('Por favor completa todos los campos');
                return;
            }
            
            // Crear nueva conversación
            const newConversation = {
                id: Date.now(),
                name: document.getElementById('recipient-select').selectedOptions[0].textContent,
                type: type,
                lastMessage: content,
                time: 'Ahora',
                unread: 0,
                priority: priority
            };
            
            conversations.unshift(newConversation);
            loadConversations();
            
            // Cerrar modal
            closeNewMessageModal();
            
            // Seleccionar la nueva conversación
            selectConversation(newConversation);
        });

        // Modal de configuración
        function openSettingsModal() {
            document.getElementById('settingsModal').style.display = 'flex';
        }

        function closeSettingsModal() {
            document.getElementById('settingsModal').style.display = 'none';
        }

        // Guardar configuración
        document.getElementById('settingsForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Actualizar información del usuario
            currentUser.name = document.getElementById('settings-name').value;
            currentUser.email = document.getElementById('settings-email').value;
            currentUser.institution = document.getElementById('settings-institution').value;
            
            const password = document.getElementById('settings-password').value;
            if (password) {
                // Aquí se cambiaría la contraseña en el servidor
                console.log('Contraseña cambiada');
            }
            
            // Actualizar UI
            loadUserInfo();
            closeSettingsModal();
            
            alert('Configuración guardada exitosamente');
        });

        // Toggle password
        function togglePassword(inputId) {
            const input = document.getElementById(inputId);
            const icon = event.currentTarget.querySelector('i');
            
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }

        // Cerrar sesión
        function logout() {
            if (confirm('¿Estás seguro de que quieres cerrar sesión?')) {
                window.location.href = 'login.html';
            }
        }

        // Actualizar indicador de prioridad en el chat
        function updatePriorityIndicator() {
            const priority = document.getElementById('chat-message-priority').value;
            const prioritySelector = document.querySelector('.priority-selector');
            
            // Remover clases de prioridad anteriores
            prioritySelector.classList.remove('priority-baja', 'priority-media', 'priority-alta');
            // Agregar nueva clase de prioridad
            prioritySelector.classList.add(`priority-${priority}`);
        }

        // Cerrar modales al hacer clic fuera
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }
    </script>
</body>
</html>
