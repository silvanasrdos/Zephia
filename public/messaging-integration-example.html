<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ejemplo de Integración - Sistema de Mensajería Zephia</title>
    <link rel="stylesheet" href="styles-messaging.css">
</head>
<body>
    <h1>Ejemplo de Integración del Sistema de Mensajería</h1>
    
    <h2>Para integrar el sistema de mensajería en tus páginas HTML:</h2>
    
    <h3>1. Agregar los estilos CSS necesarios en el &lt;head&gt;:</h3>
    <pre><code>&lt;link rel="stylesheet" href="styles-messaging.css"&gt;</code></pre>
    
    <h3>2. Agregar los scripts de Firebase y el sistema de mensajería antes del cierre de &lt;/body&gt;:</h3>
    <pre><code>&lt;!-- Scripts de módulos ES6 --&gt;
&lt;script type="module"&gt;
    // Importar servicios
    import './firebase-config.js';
    import messagingUI from './messaging-ui.js';

    // Configurar usuario actual (obtener de tu sistema de autenticación)
    const currentUser = {
        id: 'user_docente_123', // ID único del usuario
        name: 'Juan Pérez',
        email: 'juan.perez@escuela.com',
        role: 'docente', // o 'secretaria', 'responsable', 'admin'
        type: 'docente',
        avatar: null, // opcional
        schoolId: 'school1', // opcional
        schoolName: 'Escuela San Martín' // opcional
    };

    // Inicializar la UI de mensajería cuando el DOM esté listo
    document.addEventListener('DOMContentLoaded', async function() {
        try {
            // Inicializar mensajería
            await messagingUI.initialize(currentUser);
            
            console.log('Sistema de mensajería inicializado correctamente');
        } catch (error) {
            console.error('Error al inicializar mensajería:', error);
        }
    });

    // Hacer las funciones disponibles globalmente
    window.openNewMessageModal = () => messagingUI.openNewMessageModal();
    window.updatePriorityColor = (el) => messagingUI.updatePriorityColor(el);
&lt;/script&gt;</code></pre>

    <h3>3. Estructura HTML requerida (ya existe en docente.html, secretaria.html, responsable.html):</h3>
    <pre><code>&lt;div class="messaging-wrapper"&gt;
    &lt;!-- Panel Izquierdo: Lista de Conversaciones --&gt;
    &lt;div class="conversations-panel"&gt;
        &lt;div class="conversations-header"&gt;
            &lt;h3&gt;Mensajes&lt;/h3&gt;
            &lt;button onclick="openNewMessageModal()"&gt;
                &lt;i class="fas fa-plus"&gt;&lt;/i&gt;
            &lt;/button&gt;
        &lt;/div&gt;
        
        &lt;div class="conversations-search"&gt;
            &lt;input type="text" id="conversation-search" placeholder="Buscar"&gt;
        &lt;/div&gt;
        
        &lt;div class="conversations-list" id="conversations-list"&gt;
            &lt;!-- Las conversaciones se cargan dinámicamente --&gt;
        &lt;/div&gt;
    &lt;/div&gt;

    &lt;!-- Panel Derecho: Chat --&gt;
    &lt;div class="chat-panel"&gt;
        &lt;div class="chat-header"&gt;
            &lt;!-- Información del chat --&gt;
        &lt;/div&gt;

        &lt;div class="chat-messages" id="chat-messages"&gt;
            &lt;!-- Los mensajes se cargan dinámicamente --&gt;
        &lt;/div&gt;

        &lt;div class="chat-input-container"&gt;
            &lt;input type="text" class="chat-input" placeholder="Escribe un mensaje..."&gt;
            &lt;select class="priority-selector-input normal" id="priority-selector" 
                    onchange="updatePriorityColor(this)"&gt;
                &lt;option value="normal"&gt;Normal&lt;/option&gt;
                &lt;option value="baja"&gt;Baja&lt;/option&gt;
                &lt;option value="media"&gt;Media&lt;/option&gt;
                &lt;option value="alta"&gt;Alta&lt;/option&gt;
            &lt;/select&gt;
            &lt;button class="send-btn"&gt;
                &lt;i class="fas fa-paper-plane"&gt;&lt;/i&gt;
            &lt;/button&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/div&gt;</code></pre>

    <h3>4. Crear usuarios de prueba en Firestore:</h3>
    <p>Para poder enviar mensajes, necesitas crear documentos en la colección 'users' en Firestore:</p>
    <pre><code>// Colección: users
// Documento ID: user_docente_123
{
    name: "Juan Pérez",
    email: "juan.perez@escuela.com",
    role: "docente",
    avatar: null,
    online: false,
    lastSeen: timestamp,
    schoolId: "school1"
}

// Documento ID: user_secretaria_456
{
    name: "Ana López",
    email: "ana.lopez@escuela.com",
    role: "secretaria",
    avatar: null,
    online: false,
    lastSeen: timestamp,
    schoolId: "school1"
}

// Documento ID: user_responsable_789
{
    name: "María García",
    email: "maria.garcia@escuela.com",
    role: "responsable",
    avatar: null,
    online: false,
    lastSeen: timestamp,
    schoolId: "school1"
}</code></pre>

    <h3>5. Estructura de colecciones en Firestore:</h3>
    <ul>
        <li><strong>users</strong>: Información de usuarios del sistema</li>
        <li><strong>conversations</strong>: Conversaciones entre usuarios</li>
        <li><strong>messages</strong>: Mensajes individuales</li>
    </ul>

    <h3>6. Funciones disponibles:</h3>
    <ul>
        <li><code>messagingUI.initialize(currentUser)</code> - Inicializar el sistema</li>
        <li><code>messagingUI.openNewMessageModal()</code> - Abrir modal para nuevo mensaje</li>
        <li><code>messagingUI.updatePriorityColor(element)</code> - Actualizar color de prioridad</li>
        <li><code>messagingUI.cleanup()</code> - Limpiar listeners al cerrar sesión</li>
    </ul>

    <h3>7. Características implementadas:</h3>
    <ul>
        <li>✅ Mensajería en tiempo real con Firebase Firestore</li>
        <li>✅ Lista de conversaciones con últimos mensajes</li>
        <li>✅ Contador de mensajes no leídos</li>
        <li>✅ Búsqueda de conversaciones</li>
        <li>✅ Crear nuevas conversaciones</li>
        <li>✅ Enviar mensajes con diferentes prioridades</li>
        <li>✅ Marcar mensajes como leídos automáticamente</li>
        <li>✅ Indicador de usuarios en línea</li>
        <li>✅ Formateo de fechas relativas (Hoy, Ayer, etc.)</li>
        <li>✅ Scroll automático a últimos mensajes</li>
        <li>✅ Interfaz responsive</li>
    </ul>

    <h3>8. Reglas de seguridad de Firestore (firestore.rules):</h3>
    <pre><code>rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Usuarios pueden leer todos los usuarios
    match /users/{userId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Conversaciones solo visibles para participantes
    match /conversations/{conversationId} {
      allow read: if request.auth != null && 
                     request.auth.uid in resource.data.participants;
      allow create: if request.auth != null && 
                       request.auth.uid in request.resource.data.participants;
      allow update: if request.auth != null && 
                       request.auth.uid in resource.data.participants;
    }
    
    // Mensajes solo visibles para participantes de la conversación
    match /messages/{messageId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && 
                       request.auth.uid == request.resource.data.senderId;
      allow update: if request.auth != null;
    }
  }
}</code></pre>

    <h3>9. Índices compuestos necesarios en Firestore:</h3>
    <p>Firebase te pedirá crear estos índices la primera vez que uses las consultas. También puedes crearlos manualmente:</p>
    <ul>
        <li>Colección: <code>conversations</code>
            <ul>
                <li>Campo: <code>participants</code> (Array)</li>
                <li>Campo: <code>updatedAt</code> (Descendente)</li>
            </ul>
        </li>
        <li>Colección: <code>messages</code>
            <ul>
                <li>Campo: <code>conversationId</code> (Ascendente)</li>
                <li>Campo: <code>timestamp</code> (Ascendente)</li>
            </ul>
        </li>
    </ul>

    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        h1 {
            color: #8b4513;
            border-bottom: 3px solid #8b4513;
            padding-bottom: 10px;
        }
        
        h2 {
            color: #333;
            margin-top: 30px;
        }
        
        h3 {
            color: #555;
            margin-top: 25px;
        }
        
        pre {
            background-color: #2d2d2d;
            color: #f8f8f2;
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
            border-left: 4px solid #8b4513;
        }
        
        code {
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }
        
        ul {
            line-height: 1.8;
        }
        
        li {
            margin-bottom: 8px;
        }
        
        p {
            line-height: 1.6;
            color: #555;
        }
    </style>
</body>
</html>

