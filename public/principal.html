<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Panel administrativo para gestión de escuelas y docentes">
    <meta name="theme-color" content="#8b4513">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Zephia">
    <title>Zephia - Panel Administrativo</title>
    <link rel="icon" type="image/png" href="img/logo.png">
    <link rel="apple-touch-icon" href="img/logo.png">
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="styles-principal.css?v=2">
    <link rel="stylesheet" href="styles-messaging.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- Chart.js para gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <!-- Firebase SDK Compat -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <!-- Sistema de Mensajería -->
    <script src="messaging-service-compat.js"></script>
    <script src="messaging-ui-compat.js"></script>
</head>
<body>
    <div class="admin-container">
        <!-- Sidebar -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <img src="img/logo.png" alt="Zephia Logo" class="logo">
                <h2>Zephia</h2>
                    </div>
            <ul class="nav-menu">
                <li class="nav-item" onclick="showSection('messaging')">
                    <i class="fas fa-envelope"></i>
                    <span>Mensajería</span>
                </li>
                <li class="nav-item" onclick="showSection('dashboard')">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Dashboard</span>
                </li>
                <li class="nav-item" onclick="showSection('schools')">
                    <i class="fas fa-school"></i>
                    <span>Escuelas</span>
                </li>
                <li class="nav-item" onclick="showSection('teachers')">
                    <i class="fas fa-chalkboard-teacher"></i>
                    <span>Docentes</span>
                </li>
                <li class="nav-item" onclick="showSection('users')">
                    <i class="fas fa-users"></i>
                    <span>Usuarios</span>
                </li>
                <li class="nav-item" onclick="showSection('reports')">
                    <i class="fas fa-chart-bar"></i>
                    <span>Reportes</span>
                </li>
                <li class="nav-item" onclick="showSection('support')">
                    <i class="fas fa-life-ring"></i>
                    <span>Soporte</span>
                </li>
            </ul>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <header class="header">
                <div class="breadcrumb">
                    <h2 id="section-title">Dashboard</h2>
                    <p id="section-description">Panel principal del sistema administrativo</p>
                </div>
                <div class="header-actions">
                    <button class="action-btn" id="add-btn" style="display: none;">
                        <i class="fas fa-plus"></i> Agregar
                    </button>
                    <button class="action-btn logout-btn" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
                                </button>
                            </div>
            </header>

            <!-- Dashboard Section -->
            <section id="dashboard-section" class="section" style="display: none;">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-school"></i>
                            </div>
                        <div class="stat-content">
                            <h3 class="stat-number" id="total-schools">0</h3>
                            <p class="stat-label">Escuelas</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-chalkboard-teacher"></i>
                            </div>
                        <div class="stat-content">
                            <h3 class="stat-number" id="total-teachers">0</h3>
                            <p class="stat-label">Docentes</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-users"></i>
                            </div>
                        <div class="stat-content">
                            <h3 class="stat-number" id="total-users">0</h3>
                            <p class="stat-label">Usuarios</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">
                            <i class="fas fa-envelope"></i>
                            </div>
                        <div class="stat-content">
                            <h3 class="stat-number" id="total-messages">0</h3>
                            <p class="stat-label">Mensajes</p>
                            </div>
                        </div>
                    </div>
            </section>

            <!-- Schools Section -->
            <section id="schools-section" class="section" style="display: none;">
                <div class="section-header">
                    <div class="search-container">
                        <i class="fas fa-search"></i>
                        <input type="text" id="schools-search" placeholder="Buscar por institución, dirección, nivel..." onkeyup="filterSchools()">
                    </div>
                    <div class="filter-checkbox">
                        <label>
                            <input type="checkbox" id="show-inactive-schools" onchange="filterSchools()">
                            <span>Mostrar inactivas</span>
                        </label>
                    </div>
                    <button class="btn-primary" onclick="openModal('school-modal')">
                        <i class="fas fa-plus"></i> Agregar Escuela
                    </button>
                </div>
                <div class="table-container">
                    <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Institución</th>
                                        <th>Dirección</th>
                                        <th>Nivel Educativo</th>
                                        <th>Turnos</th>
                                        <th>Teléfono</th>
                                <th>Email</th>
                                        <th>Docentes</th>
                                        <th>Estado</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="schools-table-body">
                            <!-- Los datos se cargarán aquí -->
                                </tbody>
                            </table>
                        </div>
            </section>

            <!-- Teachers Section -->
            <section id="teachers-section" class="section" style="display: none;">
                <div class="section-header">
                    <div class="search-container">
                        <i class="fas fa-search"></i>
                        <input type="text" id="teachers-search" placeholder="Buscar por nombre, usuario, email, rol..." onkeyup="filterTeachers()">
                    </div>
                    <div class="filter-checkbox">
                        <label>
                            <input type="checkbox" id="show-inactive-teachers" onchange="filterTeachers()">
                            <span>Mostrar inactivos</span>
                        </label>
                    </div>
                    <button class="btn-primary" onclick="openModal('teacher-modal')">
                        <i class="fas fa-plus"></i> Agregar Docente
                    </button>
                </div>
                <div class="table-container">
                    <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Usuario</th>
                                        <th>Nombre Completo</th>
                                        <th>Rol</th>
                                        <th>Escuelas</th>
                                        <th>Materias</th>
                                        <th>Email</th>
                                        <th>Teléfono</th>
                                        <th>Estado</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="teachers-table-body">
                            <!-- Los datos se cargarán aquí -->
                                </tbody>
                            </table>
                        </div>
            </section>

            <!-- Users Section -->
            <section id="users-section" class="section" style="display: none;">
                <div class="section-header">
                    <div class="search-container">
                        <i class="fas fa-search"></i>
                        <input type="text" id="users-search" placeholder="Buscar por usuario, nombre, email, tipo..." onkeyup="filterUsers()">
                    </div>
                    <div class="filter-checkbox">
                        <label>
                            <input type="checkbox" id="show-inactive-users" onchange="filterUsers()">
                            <span>Mostrar inactivos</span>
                        </label>
                    </div>
                    <button class="btn-primary" onclick="openModal('user-modal')">
                        <i class="fas fa-plus"></i> Agregar Usuario
                    </button>
                </div>
                <div class="table-container">
                    <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Usuario</th>
                                        <th>Nombre Completo</th>
                                        <th>Email</th>
                                <th>Tipo</th>
                                        <th>Estado</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="users-table-body">
                            <!-- Los datos se cargarán aquí -->
                                </tbody>
                            </table>
                        </div>
            </section>

            <!-- Messaging Section -->
            <section id="messaging-section" class="section" style="display: none;">
                <div class="messaging-wrapper">
                    <!-- Panel Izquierdo: Lista de Conversaciones -->
                    <div class="conversations-panel">
                        <div class="conversations-header">
                            <button class="header-icon-btn" title="Menu">
                                <i class="fas fa-bars"></i>
                            </button>
                            <h3>Mensajes</h3>
                            <div class="header-actions">
                                <button class="header-icon-btn" title="Nuevo mensaje" onclick="openNewMessageModal()">
                                    <i class="fas fa-plus"></i>
                                </button>
                                <button class="header-icon-btn" title="Actualizar">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                                <button class="header-icon-btn" title="Más opciones">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="conversations-search">
                            <i class="fas fa-search"></i>
                            <input type="text" id="conversation-search" placeholder="Buscar conversaciones">
                        </div>
                        
                        <div class="conversations-list" id="conversations-list">
                            <!-- Las conversaciones se cargarán dinámicamente aquí -->
                            <div class="empty-state">
                                <i class="fas fa-inbox"></i>
                                <p>No hay conversaciones aún</p>
                                <small>Inicia una nueva conversación usando el botón +</small>
                            </div>
                        </div>
                    </div>

                    <!-- Panel Derecho: Chat -->
                    <div class="chat-panel">
                        <div class="chat-header">
                            <div class="chat-user-info">
                                <div class="chat-avatar">
                                    <i class="fas fa-user"></i>
                                </div>
                                <div class="chat-user-details">
                                    <h3>Selecciona una conversación</h3>
                                    <span class="user-status">-</span>
                                </div>
                            </div>
                            <div class="chat-header-actions">
                                <button class="header-icon-btn" title="Buscar">
                                    <i class="fas fa-search"></i>
                                </button>
                                <button class="header-icon-btn" title="Más opciones">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                            </div>
                        </div>

                        <div class="chat-messages" id="chat-messages">
                            <!-- Los mensajes se cargarán dinámicamente aquí -->
                            <div class="empty-state">
                                <i class="fas fa-comments"></i>
                                <p>Selecciona una conversación</p>
                                <small>Elige una conversación de la lista para comenzar</small>
                            </div>
                        </div>

                        <div class="chat-input-container">
                            <button class="emoji-btn" title="Emojis">
                                <i class="fas fa-smile"></i>
                            </button>
                            <button class="attachment-btn" title="Adjuntar archivo" onclick="openFileSelector()">
                                <i class="fas fa-paperclip"></i>
                            </button>
                            <input type="file" id="file-input" class="file-input-hidden" accept=".odt,.ods,.odp,.doc,.docx,.xls,.xlsx,.ppt,.pptx" onchange="handleFileSelect(event)">
                            <input type="text" class="chat-input" placeholder="Escribe un mensaje...">
                            <select class="priority-selector-input normal" id="priority-selector" title="Prioridad" onchange="updatePriorityColor(this)">
                                <option value="normal">Normal</option>
                                <option value="baja">Baja</option>
                                <option value="media">Media</option>
                                <option value="alta">Alta</option>
                            </select>
                            <button class="send-btn" title="Enviar">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                        <div id="attachment-preview" class="attachment-preview"></div>
                    </div>
                </div>
            </section>

            <!-- Reports Section -->
            <section id="reports-section" class="section" style="display: none;">
                <div class="reports-container">
                    <div class="reports-header">
                        <h3><i class="fas fa-chart-line"></i> Estadísticas de Mensajería</h3>
                        <div class="report-filters">
                            <select id="report-period" onchange="loadReports()">
                                <option value="7">Últimos 7 días</option>
                                <option value="30" selected>Últimos 30 días</option>
                                <option value="90">Últimos 90 días</option>
                                <option value="all">Todo el período</option>
                            </select>
                            <button class="btn-primary" onclick="loadReports()">
                                <i class="fas fa-sync-alt"></i> Actualizar
                            </button>
                        </div>
                    </div>

                    <div class="reports-grid">
                        <!-- Gráfico: Uso por Rol -->
                        <div class="report-card">
                            <h4><i class="fas fa-users"></i> Uso de Mensajería por Rol</h4>
                            <div class="report-content">
                                <canvas id="chartRoles" style="max-height: 300px;"></canvas>
                            </div>
                        </div>

                        <!-- Gráfico: Uso por Día -->
                        <div class="report-card">
                            <h4><i class="fas fa-calendar-alt"></i> Actividad por Día de la Semana</h4>
                            <div class="report-content">
                                <canvas id="chartDays" style="max-height: 300px;"></canvas>
                            </div>
                        </div>

                        <!-- Gráfico: Uso por Prioridad -->
                        <div class="report-card">
                            <h4><i class="fas fa-exclamation-circle"></i> Mensajes por Prioridad</h4>
                            <div class="report-content">
                                <canvas id="chartPriorities" style="max-height: 300px;"></canvas>
                            </div>
                        </div>

                        <!-- Estadísticas generales -->
                        <div class="report-card">
                            <h4><i class="fas fa-chart-bar"></i> Resumen General</h4>
                            <div class="report-content">
                                <div class="report-stats">
                                    <div class="stat-item">
                                        <span class="stat-number" id="total-report-messages">0</span>
                                        <span class="stat-label">Total Conversaciones</span>
                                    </div>
                                    <div class="stat-item">
                                        <span class="stat-number" id="avg-daily-messages">0</span>
                                        <span class="stat-label">Promedio Diario</span>
                                    </div>
                                    <div class="stat-item">
                                        <span class="stat-number" id="most-active-role">-</span>
                                        <span class="stat-label">Rol Más Activo</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Support Section -->
            <section id="support-section" class="section" style="display: none;">
                <div class="support-container">
                    <!-- Filtros y estadísticas -->
                    <div class="support-header">
                        <div class="support-stats">
                            <div class="support-stat pending">
                                <i class="fas fa-clock"></i>
                                <div>
                                    <strong id="pending-count">0</strong>
                                    <span>Pendientes</span>
                                </div>
                            </div>
                            <div class="support-stat in-progress">
                                <i class="fas fa-spinner"></i>
                                <div>
                                    <strong id="in-progress-count">0</strong>
                                    <span>En proceso</span>
                                </div>
                            </div>
                            <div class="support-stat resolved">
                                <i class="fas fa-check-circle"></i>
                                <div>
                                    <strong id="resolved-count">0</strong>
                                    <span>Resueltas</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="support-filters">
                            <select id="status-filter" onchange="filterSupportRequests()">
                                <option value="all">Todos los estados</option>
                                <option value="pending">Pendientes</option>
                                <option value="in_progress">En proceso</option>
                                <option value="resolved">Resueltas</option>
                            </select>
                            
                            <select id="priority-filter" onchange="filterSupportRequests()">
                                <option value="all">Todas las prioridades</option>
                                <option value="alta">Alta</option>
                                <option value="normal">Normal</option>
                                <option value="baja">Baja</option>
                            </select>
                            
                            <button class="action-btn" onclick="refreshSupportRequests()">
                                <i class="fas fa-sync-alt"></i> Actualizar
                            </button>
                        </div>
                    </div>

                    <!-- Lista de solicitudes -->
                    <div class="support-requests-list" id="support-requests-list">
                        <div class="loading-state">
                            <i class="fas fa-spinner fa-spin"></i>
                            <p>Cargando solicitudes...</p>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Modal para Agregar Escuela -->
    <div id="school-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Agregar Escuela</h3>
                <button class="modal-close" onclick="closeModal('school-modal')">&times;</button>
            </div>
            <form id="school-form">
                <div class="school-form-grid">
                    <!-- Columna Izquierda -->
                    <div class="form-column">
                <div class="form-group">
                            <label for="school-nombre">Nombre de la Institución *</label>
                            <input type="text" id="school-nombre" name="nombreInstitucion" required placeholder="Ej: Escuela Primaria San Martín" maxlength="200">
                            <small>Máximo 200 caracteres (sin caracteres especiales)</small>
                </div>
                        
                        <fieldset class="form-fieldset">
                            <legend>Dirección *</legend>
                <div class="form-group">
                                <label for="school-calle">Calle y Número</label>
                                <input type="text" id="school-calle" name="calle" required placeholder="Ej: Av. San Martín 1234" maxlength="150">
                                <small>Máximo 150 caracteres</small>
                </div>
                            <div class="form-inline-grid">
                <div class="form-group">
                                    <label for="school-ciudad">Ciudad</label>
                                    <input type="text" id="school-ciudad" name="ciudad" required placeholder="Ej: Buenos Aires" maxlength="150">
                </div>
                <div class="form-group">
                                    <label for="school-provincia">Provincia</label>
                                    <input type="text" id="school-provincia" name="provincia" required placeholder="Ej: Buenos Aires" maxlength="150">
                </div>
                            </div>
                        </fieldset>

                        <div class="form-group">
                            <label for="school-telefono">Teléfono de Contacto *</label>
                            <input type="tel" id="school-telefono" name="telefonoContacto" required placeholder="Ej: +54 11 1234-5678" maxlength="30">
                            <small>Formato argentino (máx. 30 caracteres)</small>
                        </div>

                        <div class="form-group">
                            <label for="school-correo">Correo Institucional *</label>
                            <input type="email" id="school-correo" name="correoInstitucional" required placeholder="contacto@escuela.edu.ar" maxlength="100">
                            <small>Máximo 100 caracteres</small>
                        </div>

                        <div class="form-group">
                            <label for="school-cue">CUE (Código Único de Establecimiento)</label>
                            <input type="text" id="school-cue" name="cue" placeholder="Ej: 020001234" maxlength="9" pattern="[0-9]{9}">
                            <small>9 dígitos numéricos (opcional)</small>
                        </div>
                    </div>
                    
                    <!-- Columna Derecha -->
                    <div class="form-column">
                        <div class="form-group">
                            <label for="school-nivel">Nivel Educativo</label>
                            <select id="school-nivel" name="nivelEducativo" multiple size="3" required>
                                <option value="inicial">Inicial</option>
                                <option value="primario">Primario</option>
                                <option value="secundario">Secundario</option>
                            </select>
                            <small>Mantén Ctrl presionado para seleccionar múltiples niveles</small>
                        </div>

                        <div class="form-group">
                            <label for="school-turnos">Turnos</label>
                            <select id="school-turnos" name="turnos" multiple size="3" required>
                                <option value="mañana">Mañana</option>
                                <option value="tarde">Tarde</option>
                                <option value="noche">Noche</option>
                            </select>
                            <small>Mantén Ctrl presionado para seleccionar múltiples turnos</small>
                        </div>

                        <div class="form-group">
                            <label for="school-admin">Administrador Responsable</label>
                            <select id="school-admin" name="administradorResponsable" required>
                                <option value="">Seleccionar administrador</option>
                                <!-- Se cargarán dinámicamente los administradores -->
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="school-estado">Estado</label>
                            <select id="school-estado" name="estado">
                                <option value="activa" selected>Activa</option>
                                <option value="inactiva">Inactiva</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="school-docentes">Cantidad de Docentes (Estimada)</label>
                            <input type="number" id="school-docentes" name="cantidadDocentes" min="0" placeholder="0">
                            <small>Campo opcional - se actualizará automáticamente</small>
                        </div>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="closeModal('school-modal')">Cancelar</button>
                    <button type="submit" class="btn-primary">Guardar Escuela</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para Agregar Docente -->
    <div id="teacher-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Agregar Docente</h3>
                <button class="modal-close" onclick="closeModal('teacher-modal')">&times;</button>
            </div>
            <form id="teacher-form">
                <div class="teacher-form-grid">
                    <!-- Columna Izquierda -->
                    <div class="form-column">
                <div class="form-group">
                            <label for="teacher-usuario">Usuario/ID Docente</label>
                            <input type="text" id="teacher-usuario" name="usuario" required placeholder="Ej: docente001" maxlength="50" pattern="[a-zA-Z0-9_]+">
                            <small>Solo alfanumérico (máx. 50 caracteres)</small>
                </div>
                <div class="form-group">
                            <label for="teacher-nombre">Nombre</label>
                            <input type="text" id="teacher-nombre" name="nombre" required placeholder="Nombre del docente" maxlength="50">
                            <small>Solo letras (máx. 50 caracteres)</small>
                </div>
                <div class="form-group">
                            <label for="teacher-apellido">Apellido</label>
                            <input type="text" id="teacher-apellido" name="apellido" required placeholder="Apellido del docente" maxlength="50">
                            <small>Solo letras (máx. 50 caracteres)</small>
                </div>
                <div class="form-group">
                            <label for="teacher-correo">Correo Electrónico</label>
                            <input type="email" id="teacher-correo" name="correo" required placeholder="correo@ejemplo.com" maxlength="100">
                            <small>Máximo 100 caracteres</small>
                </div>
                <div class="form-group">
                            <label for="teacher-contraseña">Contraseña</label>
                            <input type="password" id="teacher-contraseña" name="contraseña" required placeholder="Contraseña del docente" minlength="6" maxlength="50">
                            <small>Entre 6 y 50 caracteres</small>
                </div>
                        <div class="form-group">
                            <label for="teacher-dni">DNI</label>
                            <input type="text" id="teacher-dni" name="dni" required placeholder="12345678" pattern="[0-9]{7,10}" maxlength="10">
                            <small>Entre 7 y 10 dígitos numéricos</small>
                        </div>
                    </div>
                    
                    <!-- Columna Derecha -->
                    <div class="form-column">
                        <div class="form-group">
                            <label for="teacher-rol">Rol</label>
                            <select id="teacher-rol" name="rol" required>
                                <option value="">Seleccionar rol</option>
                                <option value="profesor">Profesor</option>
                                <option value="maestro">Maestro</option>
                                <option value="coordinador">Coordinador</option>
                                <option value="director_academico">Director Académico</option>
                                <option value="subdirector">Subdirector</option>
                                <option value="preceptor">Preceptor</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="teacher-telefono">Teléfono de Contacto</label>
                            <input type="tel" id="teacher-telefono" name="telefono" required placeholder="Ej: +54 11 1234-5678" maxlength="30">
                            <small>Formato argentino (máx. 30 caracteres)</small>
                        </div>
                        <div class="form-group">
                            <label for="teacher-escuelas">Escuelas Asignadas</label>
                            <div class="multi-select-container">
                                <div class="search-box">
                                    <i class="fas fa-search"></i>
                                    <input type="text" id="teacher-schools-search-input" placeholder="Buscar escuela..." onkeyup="filterTeacherSchoolsList()">
                                </div>
                                <div class="selected-items" id="teacher-selected-schools">
                                    <span class="no-selection">Ninguna escuela seleccionada</span>
                                </div>
                                <div class="schools-list" id="teacher-schools-list">
                                    <!-- Las escuelas se cargarán aquí -->
                                </div>
                            </div>
                            <small>Selecciona una o varias escuelas para este docente</small>
                        </div>
                        <div class="form-group">
                            <label for="teacher-materias">Materias/Asignaturas</label>
                            <textarea id="teacher-materias" name="materias" rows="3" placeholder="Ingresa las materias separadas por comas. Ej: Matemáticas, Física, Química"></textarea>
                            <small>Separa las materias con comas</small>
                        </div>
                        <div class="form-group">
                            <label for="teacher-estado">Estado</label>
                            <select id="teacher-estado" name="estado">
                                <option value="activo" selected>Activo</option>
                                <option value="inactivo">Inactivo</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="closeModal('teacher-modal')">Cancelar</button>
                    <button type="submit" class="btn-primary">Guardar Docente</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para Agregar Usuario -->
    <div id="user-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Agregar Usuario</h3>
                <button class="modal-close" onclick="closeModal('user-modal')">&times;</button>
            </div>
            <form id="user-form">
                <div class="user-form-container">
                    <div class="form-group">
                        <label for="username">Usuario</label>
                        <input type="text" id="username" name="username" required placeholder="Ej: jperez" maxlength="50" pattern="[a-zA-Z0-9_]+">
                        <small>Nombre de usuario único (solo letras, números y guiones bajos, máx. 50 caracteres)</small>
                    </div>
                    <div class="form-group">
                        <label for="user-fullname">Nombre Completo</label>
                        <input type="text" id="user-fullname" name="fullname" required placeholder="Ej: Juan Pérez" maxlength="100">
                        <small>Máximo 100 caracteres</small>
                    </div>
                    <div class="form-group">
                        <label for="user-email">Email</label>
                        <input type="email" id="user-email" name="email" required placeholder="correo@ejemplo.com" maxlength="100">
                        <small>Se usará para recuperación de contraseña (máx. 100 caracteres)</small>
                    </div>
                    <div class="form-group">
                        <label for="user-type">Tipo de Usuario</label>
                        <select id="user-type" name="type" required>
                            <option value="">Seleccionar tipo de usuario...</option>
                            <option value="soporte">Soporte</option>
                            <option value="responsable">Responsable a cargo</option>
                            <option value="docente">Docente</option>
                            <option value="secretaria">Secretaria</option>
                        </select>
                        <small>Define los permisos y accesos del usuario</small>
                    </div>
                    <div class="form-group">
                        <label for="user-schools">Escuelas Asignadas</label>
                        <div class="multi-select-container">
                            <div class="search-box">
                                <i class="fas fa-search"></i>
                                <input type="text" id="schools-search-input" placeholder="Buscar escuela..." onkeyup="filterSchoolsList()">
                            </div>
                            <div class="selected-items" id="selected-schools">
                                <span class="no-selection">Ninguna escuela seleccionada</span>
                            </div>
                            <div class="schools-list" id="schools-list">
                                <!-- Las escuelas se cargarán aquí -->
                            </div>
                        </div>
                        <small>Selecciona una o varias escuelas para este usuario</small>
                    </div>
                    <div class="form-group">
                        <label for="user-password">Contraseña</label>
                        <input type="password" id="user-password" name="password" required placeholder="Mínimo 6 caracteres" minlength="6" maxlength="50">
                        <div class="password-strength">
                            <div class="password-strength-bar"></div>
                        </div>
                        <small>Entre 6 y 50 caracteres</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="closeModal('user-modal')">Cancelar</button>
                    <button type="submit" class="btn-primary">Guardar Usuario</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para Nuevo Mensaje -->
    <div id="new-message-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Nuevo Mensaje</h3>
                <button class="modal-close" onclick="closeModal('new-message-modal')">&times;</button>
            </div>
            <form id="new-message-form">
                <div class="form-group">
                    <label for="recipient-type">Tipo de Destinatario</label>
                    <select id="recipient-type" name="recipient-type" required>
                        <option value="">Seleccionar...</option>
                        <option value="school">Escuela</option>
                        <option value="teacher">Docente</option>
                        <option value="multiple">Múltiples</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="message-subject">Asunto</label>
                    <input type="text" id="message-subject" name="subject" required>
                </div>
                <div class="form-group">
                    <label for="initial-message">Mensaje</label>
                    <textarea id="initial-message" name="message" rows="4" required></textarea>
                    </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="closeModal('new-message-modal')">Cancelar</button>
                    <button type="submit" class="btn-primary">Enviar Mensaje</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para Ver Detalles de Docente -->
    <div id="teacher-details-modal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3><i class="fas fa-user-graduate"></i> Detalles del Docente</h3>
                <button class="modal-close" onclick="closeModal('teacher-details-modal')">&times;</button>
            </div>
            <div class="teacher-details-content">
                <div class="detail-section">
                    <h4><i class="fas fa-id-card"></i> Información Personal</h4>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <span class="detail-label">Usuario:</span>
                            <span class="detail-value" id="detail-usuario">-</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Nombre Completo:</span>
                            <span class="detail-value" id="detail-nombre">-</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">DNI:</span>
                            <span class="detail-value" id="detail-dni">-</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Rol:</span>
                            <span class="detail-value" id="detail-rol">-</span>
                        </div>
                    </div>
                </div>

                <div class="detail-section">
                    <h4><i class="fas fa-envelope"></i> Información de Contacto</h4>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <span class="detail-label">Correo:</span>
                            <span class="detail-value" id="detail-correo">-</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Teléfono:</span>
                            <span class="detail-value" id="detail-telefono">-</span>
                        </div>
                    </div>
                </div>

                <div class="detail-section">
                    <h4><i class="fas fa-school"></i> Información Académica</h4>
                    <div class="detail-item full-width">
                        <span class="detail-label">Escuelas Asignadas:</span>
                        <div class="detail-value schools-list" id="detail-escuelas">
                            <span class="no-data">Sin escuelas asignadas</span>
                        </div>
                    </div>
                    <div class="detail-item full-width">
                        <span class="detail-label">Materias/Asignaturas:</span>
                        <div class="detail-value subjects-list" id="detail-materias">
                            <span class="no-data">Sin materias asignadas</span>
                        </div>
                    </div>
                </div>

                <div class="detail-section">
                    <h4><i class="fas fa-info-circle"></i> Estado y Fechas</h4>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <span class="detail-label">Estado:</span>
                            <span class="detail-value" id="detail-estado">-</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Fecha de Alta:</span>
                            <span class="detail-value" id="detail-fecha">-</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeModal('teacher-details-modal')">
                    <i class="fas fa-times"></i> Cerrar
                </button>
                <button type="button" class="btn-primary" onclick="editTeacherFromDetails()">
                    <i class="fas fa-edit"></i> Editar Docente
                </button>
            </div>
        </div>
    </div>

    <!-- Modal para Ver Detalles de Escuela -->
    <div id="school-details-modal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3><i class="fas fa-school"></i> Detalles de la Escuela</h3>
                <button class="modal-close" onclick="closeModal('school-details-modal')">&times;</button>
            </div>
            <div class="school-details-content">
                <div class="detail-section">
                    <h4><i class="fas fa-building"></i> Información Institucional</h4>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <span class="detail-label">Nombre de la Institución:</span>
                            <span class="detail-value" id="detail-school-nombre">-</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">CUE:</span>
                            <span class="detail-value" id="detail-school-cue">-</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Estado:</span>
                            <span class="detail-value" id="detail-school-estado">-</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Cantidad de Docentes:</span>
                            <span class="detail-value" id="detail-school-docentes">-</span>
                        </div>
                    </div>
                </div>

                <div class="detail-section">
                    <h4><i class="fas fa-map-marker-alt"></i> Dirección</h4>
                    <div class="detail-item full-width">
                        <span class="detail-label">Dirección Completa:</span>
                        <span class="detail-value" id="detail-school-direccion">-</span>
                    </div>
                </div>

                <div class="detail-section">
                    <h4><i class="fas fa-phone"></i> Información de Contacto</h4>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <span class="detail-label">Teléfono:</span>
                            <span class="detail-value" id="detail-school-telefono">-</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Correo Institucional:</span>
                            <span class="detail-value" id="detail-school-correo">-</span>
                        </div>
                    </div>
                </div>

                <div class="detail-section">
                    <h4><i class="fas fa-graduation-cap"></i> Información Académica</h4>
                    <div class="detail-item full-width">
                        <span class="detail-label">Niveles Educativos:</span>
                        <div class="detail-value levels-list" id="detail-school-niveles">
                            <span class="no-data">Sin niveles definidos</span>
                        </div>
                    </div>
                    <div class="detail-item full-width">
                        <span class="detail-label">Turnos:</span>
                        <div class="detail-value shifts-list" id="detail-school-turnos">
                            <span class="no-data">Sin turnos definidos</span>
                        </div>
                    </div>
                </div>

                <div class="detail-section">
                    <h4><i class="fas fa-user-tie"></i> Administración</h4>
                    <div class="detail-item full-width">
                        <span class="detail-label">Administrador Responsable:</span>
                        <span class="detail-value" id="detail-school-admin">-</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeModal('school-details-modal')">
                    <i class="fas fa-times"></i> Cerrar
                </button>
                <button type="button" class="btn-primary" onclick="editSchoolFromDetails()">
                    <i class="fas fa-edit"></i> Editar Escuela
                </button>
            </div>
        </div>
    </div>

    <!-- Modal para Ver Detalles de Usuario -->
    <div id="user-details-modal" class="modal">
        <div class="modal-content user-details-modal">
            <div class="modal-header">
                <h3><i class="fas fa-user-circle"></i> Detalles del Usuario</h3>
                <button class="modal-close" onclick="closeModal('user-details-modal')">&times;</button>
            </div>
            <div class="user-details-content">
                <!-- Avatar y nombre destacado -->
                <div class="user-profile-header">
                    <div class="user-profile-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="user-profile-info">
                        <h3 id="detail-user-fullname-header">-</h3>
                        <p class="user-profile-username">@<span id="detail-user-username-header">-</span></p>
                        <span class="user-type-badge" id="detail-user-type-badge">-</span>
                    </div>
                </div>

                <!-- Información Personal -->
                <div class="detail-section">
                    <div class="detail-section-header">
                        <i class="fas fa-id-card"></i>
                        <h4>Información Personal</h4>
                    </div>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-icon">
                                <i class="fas fa-user"></i>
                            </div>
                            <div class="detail-content">
                                <span class="detail-label">Usuario</span>
                                <span class="detail-value" id="detail-user-username">-</span>
                            </div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-icon">
                                <i class="fas fa-signature"></i>
                            </div>
                            <div class="detail-content">
                                <span class="detail-label">Nombre Completo</span>
                                <span class="detail-value" id="detail-user-fullname">-</span>
                            </div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-icon">
                                <i class="fas fa-envelope"></i>
                            </div>
                            <div class="detail-content">
                                <span class="detail-label">Email</span>
                                <span class="detail-value" id="detail-user-email">-</span>
                            </div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-icon">
                                <i class="fas fa-users-cog"></i>
                            </div>
                            <div class="detail-content">
                                <span class="detail-label">Tipo de Usuario</span>
                                <span class="detail-value" id="detail-user-type">-</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Estado y Fechas -->
                <div class="detail-section">
                    <div class="detail-section-header">
                        <i class="fas fa-info-circle"></i>
                        <h4>Estado y Actividad</h4>
                    </div>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-icon">
                                <i class="fas fa-circle"></i>
                            </div>
                            <div class="detail-content">
                                <span class="detail-label">Estado</span>
                                <span class="detail-value status-value" id="detail-user-status">-</span>
                            </div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-icon">
                                <i class="fas fa-calendar-plus"></i>
                            </div>
                            <div class="detail-content">
                                <span class="detail-label">Fecha de Creación</span>
                                <span class="detail-value" id="detail-user-created">-</span>
                            </div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-icon">
                                <i class="fas fa-clock"></i>
                            </div>
                            <div class="detail-content">
                                <span class="detail-label">Último Acceso</span>
                                <span class="detail-value" id="detail-user-access">-</span>
                            </div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-icon">
                                <i class="fas fa-edit"></i>
                            </div>
                            <div class="detail-content">
                                <span class="detail-label">Última Actualización</span>
                                <span class="detail-value" id="detail-user-updated">-</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeModal('user-details-modal')">
                    <i class="fas fa-times"></i> Cerrar
                </button>
                <button type="button" class="btn-primary" onclick="editUserFromDetails()">
                    <i class="fas fa-edit"></i> Editar Usuario
                </button>
            </div>
        </div>
    </div>

    <!-- Modal para Ver Detalles de Solicitud de Soporte -->
    <div id="support-details-modal" class="modal">
        <div class="modal-content support-details-modal">
            <div class="modal-header">
                <h3><i class="fas fa-life-ring"></i> Detalles de Solicitud de Soporte</h3>
                <button class="modal-close" onclick="closeModal('support-details-modal')">&times;</button>
            </div>
            <div class="support-details-content">
                <!-- Información de contacto -->
                <div class="detail-section">
                    <div class="detail-section-header">
                        <i class="fas fa-user"></i>
                        <h4>Información del Solicitante</h4>
                    </div>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-icon">
                                <i class="fas fa-user"></i>
                            </div>
                            <div class="detail-content">
                                <span class="detail-label">Nombre</span>
                                <span class="detail-value" id="support-detail-name">-</span>
                            </div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-icon">
                                <i class="fas fa-envelope"></i>
                            </div>
                            <div class="detail-content">
                                <span class="detail-label">Email</span>
                                <span class="detail-value" id="support-detail-email">-</span>
                            </div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-icon">
                                <i class="fas fa-phone"></i>
                            </div>
                            <div class="detail-content">
                                <span class="detail-label">Teléfono</span>
                                <span class="detail-value" id="support-detail-phone">-</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Detalles de la solicitud -->
                <div class="detail-section">
                    <div class="detail-section-header">
                        <i class="fas fa-info-circle"></i>
                        <h4>Detalles de la Solicitud</h4>
                    </div>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-icon">
                                <i class="fas fa-tag"></i>
                            </div>
                            <div class="detail-content">
                                <span class="detail-label">Tipo</span>
                                <span class="detail-value" id="support-detail-type">-</span>
                            </div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-icon">
                                <i class="fas fa-exclamation-circle"></i>
                            </div>
                            <div class="detail-content">
                                <span class="detail-label">Prioridad</span>
                                <span class="detail-value priority-badge" id="support-detail-priority">-</span>
                            </div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-icon">
                                <i class="fas fa-circle"></i>
                            </div>
                            <div class="detail-content">
                                <span class="detail-label">Estado</span>
                                <span class="detail-value status-badge" id="support-detail-status">-</span>
                            </div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-icon">
                                <i class="fas fa-calendar"></i>
                            </div>
                            <div class="detail-content">
                                <span class="detail-label">Fecha</span>
                                <span class="detail-value" id="support-detail-date">-</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Mensaje -->
                <div class="detail-section">
                    <div class="detail-section-header">
                        <i class="fas fa-comment-alt"></i>
                        <h4>Mensaje</h4>
                    </div>
                    <div class="support-message-content">
                        <p id="support-detail-message">-</p>
                    </div>
                </div>

                <!-- Cambiar estado -->
                <div class="detail-section">
                    <div class="detail-section-header">
                        <i class="fas fa-tasks"></i>
                        <h4>Gestionar Solicitud</h4>
                    </div>
                    <div class="support-actions">
                        <label for="support-status-select">Cambiar estado:</label>
                        <select id="support-status-select">
                            <option value="pending">Pendiente</option>
                            <option value="in_progress">En proceso</option>
                            <option value="resolved">Resuelta</option>
                        </select>
                        <button type="button" class="btn-primary" onclick="updateSupportStatus()">
                            <i class="fas fa-save"></i> Actualizar Estado
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeModal('support-details-modal')">
                    <i class="fas fa-times"></i> Cerrar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmación de Cierre de Sesión -->
    <div id="logout-modal" class="logout-modal" style="display: none;">
        <div class="logout-modal-content">
            <div class="logout-modal-icon">
                <i class="fas fa-sign-out-alt"></i>
            </div>
            <h3>¿Cerrar sesión?</h3>
            <p>¿Estás seguro de que deseas salir del sistema?</p>
            <div class="logout-modal-actions">
                <button class="btn-cancel" onclick="closeLogoutModal()">
                    Cancelar
                </button>
                <button class="btn-logout" onclick="confirmLogout()">
                    Cerrar Sesión
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmación Exitosa -->
    <div id="success-modal" class="success-modal" style="display: none;">
        <div class="success-modal-content">
            <div class="success-modal-icon">
                <i class="fas fa-check-circle"></i>
            </div>
            <h3 id="success-modal-title">¡Operación exitosa!</h3>
            <p id="success-modal-message">Los datos se han guardado correctamente.</p>
            <div class="success-modal-details" id="success-modal-details" style="display: none;"></div>
            <div class="success-modal-actions">
                <button class="btn-success-ok" onclick="closeSuccessModal()">
                    <i class="fas fa-check"></i> Aceptar
                </button>
            </div>
        </div>
    </div>

    <!-- Script de validaciones -->
    <script src="validaciones.js"></script>

    <!-- Firebase Initialization -->
    <script>
        // Configuración de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAebJgE_34xBGfVeiLXUs9gnisoFbIPOn4",
            authDomain: "zephia-51ad4.firebaseapp.com",
            databaseURL: "https://zephia-51ad4-default-rtdb.firebaseio.com",
            projectId: "zephia-51ad4",
            storageBucket: "zephia-51ad4.firebasestorage.app",
            messagingSenderId: "829322879330",
            appId: "1:829322879330:web:f59f5389c7ead8a6440c3b",
            measurementId: "G-75CDPLDSFX"
        };
        
        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        // Hacer disponible globalmente
        window.auth = auth;
        window.db = db;
        
        // Marcar Firebase como inicializado
        window.firebaseInitialized = true;
        
        // ===== FUNCIONES DE MENSAJERÍA (deben estar disponibles globalmente desde el inicio) =====
        
        // Abrir modal de nuevo mensaje
        window.openNewMessageModal = function() {
            if (window.messagingUI) {
                window.messagingUI.openNewMessageModal();
            } else {
                console.warn('Sistema de mensajería no inicializado');
                alert('El sistema de mensajería aún se está cargando. Por favor, intenta de nuevo en un momento.');
            }
        };
        
        // Actualizar color del selector de prioridad
        window.updatePriorityColor = function(selectElement) {
            if (window.messagingUI && window.messagingUI.updatePriorityColor) {
                window.messagingUI.updatePriorityColor(selectElement);
            } else {
                const value = selectElement.value;
                selectElement.classList.remove('normal', 'baja', 'media', 'alta');
                selectElement.classList.add(value);
            }
        };
        
        // Seleccionar conversación
        window.selectConversation = function(conversationId) {
            if (window.messagingUI && window.messagingUI.selectConversation) {
                window.messagingUI.selectConversation(conversationId);
            } else {
                console.warn('Sistema de mensajería no inicializado');
            }
        };
        
        // ===== FUNCIONES PARA MANEJO DE ARCHIVOS ADJUNTOS =====
        
        // Variable global para el archivo seleccionado
        window.selectedFile = null;
        
        // Abrir selector de archivos
        window.openFileSelector = function() {
            const fileInput = document.getElementById('file-input');
            if (fileInput) {
                fileInput.click();
            }
        };
        
        // Manejar selección de archivo
        window.handleFileSelect = function(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Validar tamaño del archivo (máximo 10MB)
            const maxSize = 10 * 1024 * 1024; // 10MB
            if (file.size > maxSize) {
                alert('El archivo es demasiado grande. El tamaño máximo es 10MB.');
                event.target.value = '';
                return;
            }
            
            // Validar extensión
            const allowedExtensions = ['.odt', '.ods', '.odp', '.doc', '.docx', '.xls', '.xlsx', '.ppt', '.pptx'];
            const fileName = file.name.toLowerCase();
            const isValidExtension = allowedExtensions.some(ext => fileName.endsWith(ext));
            
            if (!isValidExtension) {
                alert('Tipo de archivo no permitido. Solo se permiten documentos OpenDocument y Microsoft Office.');
                event.target.value = '';
                return;
            }
            
            // Guardar archivo seleccionado
            window.selectedFile = file;
            
            // Mostrar vista previa
            showAttachmentPreview(file);
        };
        
        // Mostrar vista previa del archivo
        function showAttachmentPreview(file) {
            const preview = document.getElementById('attachment-preview');
            if (!preview) return;
            
            // Obtener icono según el tipo de archivo
            const fileIcon = getFileIcon(file.name);
            
            // Formatear tamaño del archivo
            const fileSize = formatFileSize(file.size);
            
            preview.innerHTML = `
                <div class="attachment-item">
                    <div class="attachment-icon">
                        <i class="fas ${fileIcon}"></i>
                    </div>
                    <div class="attachment-info">
                        <p class="attachment-name">${file.name}</p>
                        <p class="attachment-size">${fileSize}</p>
                    </div>
                    <button class="attachment-remove" onclick="removeAttachment()" title="Quitar archivo">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            preview.classList.add('has-file');
        }
        
        // Quitar archivo adjunto
        window.removeAttachment = function() {
            window.selectedFile = null;
            const fileInput = document.getElementById('file-input');
            if (fileInput) fileInput.value = '';
            
            const preview = document.getElementById('attachment-preview');
            if (preview) {
                preview.innerHTML = '';
                preview.classList.remove('has-file');
            }
        };
        
        // Obtener icono según tipo de archivo
        function getFileIcon(fileName) {
            const ext = fileName.toLowerCase().split('.').pop();
            const icons = {
                'doc': 'fa-file-word',
                'docx': 'fa-file-word',
                'odt': 'fa-file-word',
                'xls': 'fa-file-excel',
                'xlsx': 'fa-file-excel',
                'ods': 'fa-file-excel',
                'ppt': 'fa-file-powerpoint',
                'pptx': 'fa-file-powerpoint',
                'odp': 'fa-file-powerpoint'
            };
            return icons[ext] || 'fa-file';
        }
        
        // Formatear tamaño del archivo
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }
        
        // Subir archivo a Cloudinary (GRATUITO)
        async function uploadFile(file, conversationId) {
            if (!file || !conversationId) return null;
            
            try {
                console.log('📤 Iniciando subida de archivo:', file.name);
                console.log('📤 Tamaño del archivo:', file.size);
                console.log('📤 Conversación ID:', conversationId);
                
                // Configuración de Cloudinary (GRATUITO)
                const cloudName = 'dsf9dgewq'; // Cloud Name configurado
                const uploadPreset = 'chat-attachments'; // Upload preset configurado
                
                console.log('📤 Cloud Name:', cloudName);
                console.log('📤 Upload Preset:', uploadPreset);
                
                // Crear FormData
                const formData = new FormData();
                formData.append('file', file);
                formData.append('upload_preset', uploadPreset);
                formData.append('folder', `chat-attachments/${conversationId}`);
                
                console.log('📤 FormData creado, enviando a Cloudinary...');
                
                // Subir a Cloudinary
                const response = await fetch(`https://api.cloudinary.com/v1_1/${cloudName}/raw/upload`, {
                    method: 'POST',
                    body: formData
                });
                
                console.log('📤 Respuesta de Cloudinary:', response.status, response.statusText);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('❌ Error de Cloudinary:', errorText);
                    throw new Error(`Error al subir archivo a Cloudinary: ${response.status} - ${errorText}`);
                }
                
                const data = await response.json();
                console.log('✅ Archivo subido exitosamente:', data);
                
                return {
                    name: file.name,
                    url: data.secure_url,
                    size: file.size,
                    type: file.type,
                    path: data.public_id
                };
            } catch (error) {
                console.error('❌ Error al subir archivo:', error);
                throw error;
            }
        }
        
        // Verificar autenticación
        auth.onAuthStateChanged((user) => {
            if (user) {
                console.log('Usuario autenticado:', user.email);
                initializeAppData();
            } else {
                console.log('❌ Usuario no autenticado');
                window.location.href = 'login.html';
            }
        });
        
        async function initializeAppData() {
            loadData();
            updateStats();
            initializeUserPermissions();
            await initializeMessagingSystem();
        }
        
        // Inicializar sistema de mensajería
        async function initializeMessagingSystem() {
            try {
                console.log('🔄 Inicializando sistema de mensajería...');
                
                // Verificar que messagingUI esté disponible
                if (typeof window.messagingUI === 'undefined') {
                    console.error('❌ messagingUI no está disponible');
                    return;
                }
                
                // Verificar que db esté disponible
                if (!window.db) {
                    console.error('❌ Firestore (db) no está disponible');
                    return;
                }
                
                // Obtener usuario autenticado de Firebase Auth
                const authUser = window.auth.currentUser;
                if (!authUser) {
                    console.warn('⚠️ No hay usuario autenticado');
                    return;
                }
                
                console.log('🔐 Usuario autenticado:', authUser.email, '(UID:', authUser.uid + ')');
                
                // Cargar datos del usuario desde Firestore
                const userDoc = await window.db.collection('users').doc(authUser.uid).get();
                
                let currentUser;
                if (userDoc.exists) {
                    // Usuario existe en Firestore
                    const userData = userDoc.data();
                    currentUser = {
                        id: authUser.uid,
                        name: userData.fullName || userData.name || authUser.displayName || authUser.email,
                        email: authUser.email,
                        role: userData.type || userData.role || 'admin'
                    };
                    console.log('✅ Datos de usuario cargados desde Firestore:', currentUser);
                } else {
                    // Usuario no existe en Firestore, crear documento básico
                    console.warn('⚠️ Usuario no existe en Firestore, creando documento...');
                    currentUser = {
                        id: authUser.uid,
                        name: authUser.displayName || authUser.email,
                        email: authUser.email,
                        role: 'admin'
                    };
                    
                    // Crear documento del usuario en Firestore
                    await window.db.collection('users').doc(authUser.uid).set({
                        name: currentUser.name,
                        email: currentUser.email,
                        role: currentUser.role,
                        online: false,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    console.log('✅ Documento de usuario creado en Firestore');
                }
                
                // Guardar usuario en window para uso global
                window.currentUser = currentUser;
                
                console.log('👤 Usuario para mensajería:', currentUser);
                
                // Inicializar el sistema de mensajería (pasar currentUser y db)
                await window.messagingUI.initialize(currentUser, window.db);
                
                console.log('✅ Sistema de mensajería inicializado correctamente');
            } catch (error) {
                console.error('❌ Error al inicializar mensajería:', error);
            }
        }
        
        // Función helper para verificar Firebase
        window.ensureFirebaseInitialized = function() {
            if (!window.firebaseInitialized) {
                throw new Error('Firebase aún no está inicializado. Por favor, espera un momento.');
            }
        };
        
        // Cargar datos iniciales
        async function loadData() {
            try {
                await loadSchools();
                await loadTeachers();
                await loadUsers();
                console.log('Datos cargados correctamente');
            } catch (error) {
                console.error('Error al cargar datos:', error);
            }
        }
        
        // Cargar escuelas
        async function loadSchools() {
            try {
                const schoolsRef = db.collection('schools');
                const querySnapshot = await schoolsRef.get();
                window.schools = [];
                
                querySnapshot.forEach((doc) => {
                    window.schools.push({
                        id: doc.id,
                        ...doc.data()
            });
        });

                console.log('Escuelas cargadas:', window.schools.length);
                loadSchoolsTable();
                loadSchoolsInSelect(); // Cargar escuelas en el select del formulario de docentes
            } catch (error) {
                console.error('Error al cargar escuelas:', error);
            }
        }

        // Cargar escuelas en el componente de búsqueda del formulario de docentes
        function loadSchoolsInSelect() {
            const schoolsList = document.getElementById('teacher-schools-list');
            if (!schoolsList || !window.schools) return;
            
            // Inicializar array de escuelas seleccionadas para docentes si no existe
            if (!window.selectedTeacherSchoolIds) {
                window.selectedTeacherSchoolIds = [];
            }
            
            schoolsList.innerHTML = '';
            
            window.schools.forEach(school => {
                const isChecked = window.selectedTeacherSchoolIds.includes(school.id);
                const div = document.createElement('div');
                div.className = 'school-item';
                div.innerHTML = `
                    <label>
                        <input type="checkbox" 
                               value="${school.id}" 
                               ${isChecked ? 'checked' : ''}
                               onchange="toggleTeacherSchoolSelection('${school.id}')">
                        <span>${school.nombreInstitucion || school.name || 'Sin nombre'}</span>
                    </label>
                `;
                schoolsList.appendChild(div);
            });
            
            // Actualizar visualización de escuelas seleccionadas
            updateTeacherSelectedSchoolsDisplay();
        }

        // Filtrar lista de escuelas para docentes
        window.filterTeacherSchoolsList = function() {
            const searchTerm = document.getElementById('teacher-schools-search-input').value.toLowerCase().trim();
            const schoolItems = document.querySelectorAll('#teacher-schools-list .school-item');
            
            schoolItems.forEach(item => {
                const text = item.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        };

        // Toggle selección de escuela para docente
        window.toggleTeacherSchoolSelection = function(schoolId) {
            const index = window.selectedTeacherSchoolIds.indexOf(schoolId);
            
            if (index > -1) {
                // Deseleccionar
                window.selectedTeacherSchoolIds.splice(index, 1);
            } else {
                // Seleccionar
                window.selectedTeacherSchoolIds.push(schoolId);
            }
            
            updateTeacherSelectedSchoolsDisplay();
        };

        // Actualizar visualización de escuelas seleccionadas para docente
        function updateTeacherSelectedSchoolsDisplay() {
            const container = document.getElementById('teacher-selected-schools');
            if (!container) return;
            
            if (window.selectedTeacherSchoolIds.length === 0) {
                container.innerHTML = '<span class="no-selection">Ninguna escuela seleccionada</span>';
                return;
            }
            
            container.innerHTML = '';
            
            window.selectedTeacherSchoolIds.forEach(schoolId => {
                const school = window.schools.find(s => s.id === schoolId);
                if (school) {
                    const tag = document.createElement('span');
                    tag.className = 'selected-tag';
                    tag.innerHTML = `
                        ${school.nombreInstitucion || school.name}
                        <i class="fas fa-times" onclick="toggleTeacherSchoolSelection('${schoolId}')"></i>
                    `;
                    container.appendChild(tag);
                }
            });
        }

        // Cargar administradores en el select del formulario de escuelas
        window.loadAdminsInSelect = async function(isEditing = false) {
            const select = document.getElementById('school-admin');
            const formGroup = select?.closest('.form-group');
            if (!select || !window.users) return;
            
            // Siempre mostrar el select
            select.style.display = 'block';
            
            // Eliminar mensaje informativo si existe
            const infoMsg = formGroup?.querySelector('.admin-auto-assigned');
            if (infoMsg) {
                infoMsg.remove();
            }
            
            // Limpiar opciones existentes
            select.innerHTML = '<option value="">Seleccionar administrador</option>';
            
            // Filtrar solo usuarios con rol de responsable a cargo
            const administrators = window.users.filter(user => 
                user.type === 'responsable' || user.type === 'Responsable a cargo' || user.type === 'responsable a cargo'
            );
            
            // Ordenar alfabéticamente por nombre
            administrators.sort((a, b) => {
                const nameA = (a.fullName || a.name || a.username).toLowerCase();
                const nameB = (b.fullName || b.name || b.username).toLowerCase();
                return nameA.localeCompare(nameB);
            });
            
            administrators.forEach(admin => {
                const option = document.createElement('option');
                option.value = admin.id;
                option.textContent = `${admin.fullName || admin.name || admin.username} (${admin.email})`;
                select.appendChild(option);
            });
            
            // Si no hay administradores, mostrar mensaje
            if (administrators.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'No hay responsables disponibles';
                option.disabled = true;
                select.appendChild(option);
            }
            
            console.log(`✅ ${administrators.length} responsables cargados en el selector`);
        }
        
        // Cargar docentes
        async function loadTeachers() {
            try {
                const teachersRef = db.collection('teachers');
                const querySnapshot = await teachersRef.get();
                window.teachers = [];
                
                querySnapshot.forEach((doc) => {
                    window.teachers.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                console.log('Docentes cargados:', window.teachers.length);
                loadTeachersTable();
            } catch (error) {
                console.error('Error al cargar docentes:', error);
            }
        }
        
        // Cargar usuarios
        async function loadUsers() {
            try {
                const usersRef = db.collection('users');
                const querySnapshot = await usersRef.get();
                window.users = [];
                
                querySnapshot.forEach((doc) => {
                    window.users.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                console.log('Usuarios cargados:', window.users.length);
                loadUsersTable();
                window.loadAdminsInSelect(); // Cargar administradores en el select de escuelas
            } catch (error) {
                console.error('Error al cargar usuarios:', error);
            }
        }
        
        // Actualizar estadísticas
        function updateStats() {
            document.getElementById('total-schools').textContent = window.schools ? window.schools.length : 0;
            document.getElementById('total-teachers').textContent = window.teachers ? window.teachers.length : 0;
            document.getElementById('total-users').textContent = window.users ? window.users.length : 0;
            document.getElementById('total-messages').textContent = '0';
        }
        
        // Cargar tabla de escuelas
        function loadSchoolsTable() {
            const tbody = document.getElementById('schools-table-body');
            if (!tbody || !window.schools) return;
            
            tbody.innerHTML = '';

            window.schools.forEach(school => {
                // Formatear dirección completa
                const direccionCompleta = school.direccion 
                    ? `${school.direccion.calle || ''}, ${school.direccion.ciudad || ''}, ${school.direccion.provincia || ''}`.replace(/^,\s*|,\s*$/g, '').replace(/,\s*,/g, ',')
                    : school.address || 'N/A'; // Fallback para datos antiguos

                // Formatear niveles educativos
                const nivelesText = school.nivelEducativo && school.nivelEducativo.length > 0 
                    ? school.nivelEducativo.join(', ') 
                    : 'N/A';

                // Formatear turnos
                const turnosText = school.turnos && school.turnos.length > 0 
                    ? school.turnos.join(', ') 
                    : 'N/A';

                // Truncar textos largos para la tabla
                const direccionShort = direccionCompleta.length > 30 
                    ? direccionCompleta.substring(0, 30) + '...' 
                    : direccionCompleta;

                const nivelesShort = nivelesText.length > 20 
                    ? nivelesText.substring(0, 20) + '...' 
                    : nivelesText;

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${school.nombreInstitucion || school.name || 'N/A'}</td>
                    <td title="${direccionCompleta}">${direccionShort}</td>
                    <td title="${nivelesText}">${nivelesShort}</td>
                    <td>${turnosText}</td>
                    <td>${school.telefonoContacto || school.phone || 'N/A'}</td>
                    <td>${school.correoInstitucional || school.email || 'N/A'}</td>
                    <td>${school.cantidadDocentes || school.teachers || 0}</td>
                    <td><span class="status-badge ${(school.estado === 'activa' || school.status === 'Activa') ? 'active' : 'inactive'}">${school.estado || school.status || 'activa'}</span></td>
                    <td class="actions">
                        <button class="btn-icon" onclick="viewSchool('${school.id}')" title="Ver detalles">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn-icon" onclick="editSchool('${school.id}')" title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn-icon ${(school.estado === 'activa' || school.status === 'Activa') ? 'btn-warning' : 'btn-success'}" onclick="toggleSchoolStatus('${school.id}')" title="${(school.estado === 'activa' || school.status === 'Activa') ? 'Deshabilitar' : 'Habilitar'}">
                            <i class="fas ${(school.estado === 'activa' || school.status === 'Activa') ? 'fa-ban' : 'fa-check-circle'}"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Cargar tabla de docentes
        function loadTeachersTable() {
            const tbody = document.getElementById('teachers-table-body');
            if (!tbody || !window.teachers) return;
            
            tbody.innerHTML = '';

            window.teachers.forEach(teacher => {
                // Formatear escuelas asignadas
                const escuelasText = teacher.escuelasAsignadas && teacher.escuelasAsignadas.length > 0 
                    ? getSchoolNames(teacher.escuelasAsignadas).join(', ') 
                    : 'Sin asignar';

                // Formatear materias
                const materiasText = teacher.materias && teacher.materias.length > 0 
                    ? teacher.materias.join(', ') 
                    : 'Sin materias';

                // Truncar textos largos
                const materiasShort = materiasText.length > 30 
                    ? materiasText.substring(0, 30) + '...' 
                    : materiasText;

                const escuelasShort = escuelasText.length > 25 
                    ? escuelasText.substring(0, 25) + '...' 
                    : escuelasText;

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${teacher.usuario || 'N/A'}</td>
                    <td>${teacher.nombre || ''} ${teacher.apellido || ''}</td>
                    <td><span class="role-badge ${teacher.rol || ''}">${teacher.rol || 'Sin rol'}</span></td>
                    <td title="${escuelasText}">${escuelasShort}</td>
                    <td title="${materiasText}">${materiasShort}</td>
                    <td>${teacher.correo || teacher.email || ''}</td>
                    <td>${teacher.telefono || 'N/A'}</td>
                    <td><span class="status-badge ${teacher.estado === 'activo' ? 'active' : 'inactive'}">${teacher.estado || 'activo'}</span></td>
                    <td class="actions">
                        <button class="btn-icon" onclick="viewTeacher('${teacher.id}')" title="Ver detalles">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn-icon" onclick="editTeacher('${teacher.id}')" title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn-icon ${teacher.estado === 'activo' ? 'btn-warning' : 'btn-success'}" onclick="toggleTeacherStatus('${teacher.id}')" title="${teacher.estado === 'activo' ? 'Deshabilitar' : 'Habilitar'}">
                            <i class="fas ${teacher.estado === 'activo' ? 'fa-ban' : 'fa-check-circle'}"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // ===== FUNCIONES DE BÚSQUEDA Y FILTRADO =====

        // Filtrar escuelas
        window.filterSchools = function() {
            const searchTerm = document.getElementById('schools-search').value.toLowerCase().trim();
            const showInactive = document.getElementById('show-inactive-schools').checked;
            const tbody = document.getElementById('schools-table-body');
            
            if (!tbody || !window.schools) return;
            
            // Filtrar escuelas que coincidan con el término de búsqueda y estado
            const filteredSchools = window.schools.filter(school => {
                // Filtrar por estado (activo/inactivo)
                const isActive = school.estado === 'activa' || school.status === 'Activa';
                if (!showInactive && !isActive) {
                    return false;
                }
                
                // Si no hay término de búsqueda, mostrar todas (según filtro de estado)
            if (!searchTerm) {
                    return true;
            }
            
                // Filtrar por término de búsqueda
                const nombre = (school.nombreInstitucion || school.name || '').toLowerCase();
                const direccion = school.direccion 
                    ? `${school.direccion.calle || ''} ${school.direccion.ciudad || ''} ${school.direccion.provincia || ''}`.toLowerCase()
                    : (school.address || '').toLowerCase();
                const nivel = school.nivelEducativo ? school.nivelEducativo.join(' ').toLowerCase() : '';
                const turnos = school.turnos ? school.turnos.join(' ').toLowerCase() : '';
                const telefono = (school.telefonoContacto || school.phone || '').toLowerCase();
                const email = (school.correoInstitucional || school.email || '').toLowerCase();
                const estado = (school.estado || school.status || '').toLowerCase();
                
                return nombre.includes(searchTerm) ||
                       direccion.includes(searchTerm) ||
                       nivel.includes(searchTerm) ||
                       turnos.includes(searchTerm) ||
                       telefono.includes(searchTerm) ||
                       email.includes(searchTerm) ||
                       estado.includes(searchTerm);
            });
            
            // Renderizar solo las escuelas filtradas
            tbody.innerHTML = '';
            
            if (filteredSchools.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" style="text-align: center; padding: 40px; color: #999;">
                            <i class="fas fa-search" style="font-size: 3rem; margin-bottom: 10px; display: block;"></i>
                            No se encontraron resultados para "${searchTerm}"
                        </td>
                    </tr>
                `;
                return;
            }
            
            filteredSchools.forEach(school => {
                const direccionCompleta = school.direccion 
                    ? `${school.direccion.calle || ''}, ${school.direccion.ciudad || ''}, ${school.direccion.provincia || ''}`.replace(/^,\s*|,\s*$/g, '').replace(/,\s*,/g, ',')
                    : school.address || 'N/A';
                
                const nivelesText = school.nivelEducativo && school.nivelEducativo.length > 0 
                    ? school.nivelEducativo.join(', ') 
                    : 'N/A';
                
                const turnosText = school.turnos && school.turnos.length > 0 
                    ? school.turnos.join(', ') 
                    : 'N/A';
                
                const direccionShort = direccionCompleta.length > 30 
                    ? direccionCompleta.substring(0, 30) + '...' 
                    : direccionCompleta;
                
                const nivelesShort = nivelesText.length > 20 
                    ? nivelesText.substring(0, 20) + '...' 
                    : nivelesText;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${school.nombreInstitucion || school.name || 'N/A'}</td>
                    <td title="${direccionCompleta}">${direccionShort}</td>
                    <td title="${nivelesText}">${nivelesShort}</td>
                    <td>${turnosText}</td>
                    <td>${school.telefonoContacto || school.phone || 'N/A'}</td>
                    <td>${school.correoInstitucional || school.email || 'N/A'}</td>
                    <td>${school.cantidadDocentes || school.teachers || 0}</td>
                    <td><span class="status-badge ${(school.estado === 'activa' || school.status === 'Activa') ? 'active' : 'inactive'}">${school.estado || school.status || 'activa'}</span></td>
                    <td class="actions">
                        <button class="btn-icon" onclick="viewSchool('${school.id}')" title="Ver detalles">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn-icon" onclick="editSchool('${school.id}')" title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn-icon ${(school.estado === 'activa' || school.status === 'Activa') ? 'btn-warning' : 'btn-success'}" onclick="toggleSchoolStatus('${school.id}')" title="${(school.estado === 'activa' || school.status === 'Activa') ? 'Deshabilitar' : 'Habilitar'}">
                            <i class="fas ${(school.estado === 'activa' || school.status === 'Activa') ? 'fa-ban' : 'fa-check-circle'}"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Filtrar docentes
        window.filterTeachers = function() {
            const searchTerm = document.getElementById('teachers-search').value.toLowerCase().trim();
            const showInactive = document.getElementById('show-inactive-teachers').checked;
            const tbody = document.getElementById('teachers-table-body');
            
            if (!tbody || !window.teachers) return;
            
            // Filtrar docentes que coincidan con el término de búsqueda y estado
            const filteredTeachers = window.teachers.filter(teacher => {
                // Filtrar por estado (activo/inactivo)
                const isActive = teacher.estado === 'activo';
                if (!showInactive && !isActive) {
                    return false;
                }
                
                // Si no hay término de búsqueda, mostrar todos (según filtro de estado)
            if (!searchTerm) {
                    return true;
            }
            
                // Filtrar por término de búsqueda
                const usuario = (teacher.usuario || '').toLowerCase();
                const nombre = `${teacher.nombre || ''} ${teacher.apellido || ''}`.toLowerCase();
                const rol = (teacher.rol || '').toLowerCase();
                const escuelas = teacher.escuelasAsignadas 
                    ? getSchoolNames(teacher.escuelasAsignadas).join(' ').toLowerCase()
                    : '';
                const materias = teacher.materias ? teacher.materias.join(' ').toLowerCase() : '';
                const email = (teacher.correo || teacher.email || '').toLowerCase();
                const telefono = (teacher.telefono || '').toLowerCase();
                const estado = (teacher.estado || '').toLowerCase();
                
                return usuario.includes(searchTerm) ||
                       nombre.includes(searchTerm) ||
                       rol.includes(searchTerm) ||
                       escuelas.includes(searchTerm) ||
                       materias.includes(searchTerm) ||
                       email.includes(searchTerm) ||
                       telefono.includes(searchTerm) ||
                       estado.includes(searchTerm);
            });
            
            // Renderizar solo los docentes filtrados
            tbody.innerHTML = '';
            
            if (filteredTeachers.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" style="text-align: center; padding: 40px; color: #999;">
                            <i class="fas fa-search" style="font-size: 3rem; margin-bottom: 10px; display: block;"></i>
                            No se encontraron resultados para "${searchTerm}"
                        </td>
                    </tr>
                `;
                return;
            }
            
            filteredTeachers.forEach(teacher => {
                const escuelasText = teacher.escuelasAsignadas && teacher.escuelasAsignadas.length > 0 
                    ? getSchoolNames(teacher.escuelasAsignadas).join(', ') 
                    : 'Sin asignar';
                
                const materiasText = teacher.materias && teacher.materias.length > 0 
                    ? teacher.materias.join(', ') 
                    : 'Sin materias';
                
                const materiasShort = materiasText.length > 30 
                    ? materiasText.substring(0, 30) + '...' 
                    : materiasText;
                
                const escuelasShort = escuelasText.length > 25 
                    ? escuelasText.substring(0, 25) + '...' 
                    : escuelasText;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${teacher.usuario || 'N/A'}</td>
                    <td>${teacher.nombre || ''} ${teacher.apellido || ''}</td>
                    <td><span class="role-badge ${teacher.rol || ''}">${teacher.rol || 'Sin rol'}</span></td>
                    <td title="${escuelasText}">${escuelasShort}</td>
                    <td title="${materiasText}">${materiasShort}</td>
                    <td>${teacher.correo || teacher.email || ''}</td>
                    <td>${teacher.telefono || 'N/A'}</td>
                    <td><span class="status-badge ${teacher.estado === 'activo' ? 'active' : 'inactive'}">${teacher.estado || 'activo'}</span></td>
                    <td class="actions">
                        <button class="btn-icon" onclick="viewTeacher('${teacher.id}')" title="Ver detalles">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn-icon" onclick="editTeacher('${teacher.id}')" title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn-icon ${teacher.estado === 'activo' ? 'btn-warning' : 'btn-success'}" onclick="toggleTeacherStatus('${teacher.id}')" title="${teacher.estado === 'activo' ? 'Deshabilitar' : 'Habilitar'}">
                            <i class="fas ${teacher.estado === 'activo' ? 'fa-ban' : 'fa-check-circle'}"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // ===== FUNCIONES PARA SELECCIÓN MÚLTIPLE DE ESCUELAS =====
        
        window.selectedSchoolIds = [];

        // Cargar lista de escuelas para selección
        window.loadSchoolsListForUser = function() {
            const schoolsList = document.getElementById('schools-list');
            if (!schoolsList) return;
            
            // Esperar a que las escuelas estén cargadas
            if (!window.schools || window.schools.length === 0) {
                schoolsList.innerHTML = '<div class="no-schools">Cargando escuelas...</div>';
                // Reintentar después de un breve delay
                setTimeout(() => {
                    if (window.schools && window.schools.length > 0) {
                        window.loadSchoolsListForUser();
                    } else {
                        schoolsList.innerHTML = '<div class="no-schools">No hay escuelas disponibles</div>';
                    }
                }, 500);
                return;
            }
            
            schoolsList.innerHTML = '';
            
            window.schools.forEach(school => {
                const isChecked = window.selectedSchoolIds.includes(school.id);
                const div = document.createElement('div');
                div.className = 'school-item';
                div.innerHTML = `
                    <label>
                        <input type="checkbox" 
                               value="${school.id}" 
                               ${isChecked ? 'checked' : ''}
                               onchange="toggleSchoolSelection('${school.id}')">
                        <span>${school.nombreInstitucion || school.name || 'Sin nombre'}</span>
                    </label>
                `;
                schoolsList.appendChild(div);
            });
            
            // Actualizar visualización de escuelas seleccionadas
            updateSelectedSchoolsDisplay();
        };

        // Filtrar lista de escuelas
        window.filterSchoolsList = function() {
            const searchTerm = document.getElementById('schools-search-input').value.toLowerCase().trim();
            const schoolItems = document.querySelectorAll('.school-item');
            
            schoolItems.forEach(item => {
                const text = item.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        };

        // Toggle selección de escuela
        window.toggleSchoolSelection = function(schoolId) {
            const index = window.selectedSchoolIds.indexOf(schoolId);
            
            if (index > -1) {
                // Deseleccionar
                window.selectedSchoolIds.splice(index, 1);
            } else {
                // Seleccionar
                window.selectedSchoolIds.push(schoolId);
            }
            
            updateSelectedSchoolsDisplay();
        };

        // Actualizar visualización de escuelas seleccionadas
        function updateSelectedSchoolsDisplay() {
            const container = document.getElementById('selected-schools');
            if (!container) return;
            
            if (window.selectedSchoolIds.length === 0) {
                container.innerHTML = '<span class="no-selection">Ninguna escuela seleccionada</span>';
                return;
            }
            
            const selectedSchools = window.schools.filter(school => 
                window.selectedSchoolIds.includes(school.id)
            );
            
            container.innerHTML = selectedSchools.map(school => `
                <span class="selected-tag">
                    ${school.nombreInstitucion || school.name || 'Sin nombre'}
                    <i class="fas fa-times" onclick="toggleSchoolSelection('${school.id}')"></i>
                </span>
            `).join('');
            
            // También actualizar los checkboxes
            document.querySelectorAll('.school-item input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = window.selectedSchoolIds.includes(checkbox.value);
            });
        }

        // Función para mostrar usuarios con problemas de autenticación
        function showUsersWithAuthIssues() {
            const usersWithIssues = window.users.filter(user => 
                user.authStatus === 'pending' || user.note?.includes('email ya existe')
            );
            
            if (usersWithIssues.length > 0) {
                console.warn('Usuarios con problemas de autenticación:', usersWithIssues);
                
                // Mostrar notificación en la interfaz
                const notification = document.createElement('div');
                notification.className = 'auth-issue-notification';
                notification.innerHTML = `
                    <strong>⚠️ Usuarios con problemas de autenticación</strong><br>
                    ${usersWithIssues.length} usuario(s) no pueden iniciar sesión.<br>
                    <small>Revisa la sección de usuarios para más detalles.</small>
                `;
                
                document.body.appendChild(notification);
                
                // Remover notificación después de 10 segundos
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 10000);
            }
        }

        // Cargar tabla de usuarios
        function loadUsersTable() {
            const tbody = document.getElementById('users-table-body');
            if (!tbody || !window.users) return;
            
            tbody.innerHTML = '';

            window.users.forEach(user => {
                const row = document.createElement('tr');
                
                // Verificar si el usuario tiene problemas de autenticación
                const hasAuthIssues = user.authStatus === 'pending' || user.note?.includes('email ya existe');
                const rowClass = hasAuthIssues ? 'auth-issue-row' : '';
                const authWarning = hasAuthIssues ? '<i class="fas fa-exclamation-triangle" style="color: #ffc107;" title="Problemas de autenticación"></i>' : '';
                
                row.className = rowClass;
                row.innerHTML = `
                    <td>${user.username || 'N/A'} ${authWarning}</td>
                    <td>${user.fullName || user.name || 'N/A'}</td>
                    <td>${user.email || 'N/A'}</td>
                    <td><span class="type-badge ${user.type || 'user'}">${user.type || 'Usuario'}</span></td>
                    <td>
                        <span class="status-badge ${user.status === 'Activo' ? 'active' : 'inactive'}">${user.status || 'Activo'}</span>
                        ${hasAuthIssues ? '<br><small style="color: #ffc107;">⚠️ Sin credenciales</small>' : ''}
                    </td>
                    <td class="actions">
                        <button class="btn-icon" onclick="viewUser('${user.id}')" title="Ver detalles">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn-icon" onclick="editUser('${user.id}')" title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                        ${hasAuthIssues ? 
                            `<button class="btn-icon" onclick="fixUserAuth('${user.id}')" title="Resolver problema de autenticación" style="color: #ffc107;">
                                <i class="fas fa-key"></i>
                            </button>` : ''
                        }
                        <button class="btn-icon ${user.status === 'Activo' ? 'btn-warning' : 'btn-success'}" onclick="toggleUserStatus('${user.id}')" title="${user.status === 'Activo' ? 'Deshabilitar' : 'Habilitar'}">
                            <i class="fas ${user.status === 'Activo' ? 'fa-ban' : 'fa-check-circle'}"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // Mostrar notificación si hay usuarios con problemas
            showUsersWithAuthIssues();
            
            // Aplicar filtro automáticamente (ocultar inactivos por defecto)
            filterUsers();
        }

        // Función para resolver problemas de autenticación de usuarios
        async function fixUserAuth(userId) {
            const user = window.users.find(u => u.id === userId);
            if (!user) {
                alert('Usuario no encontrado');
                return;
            }

            const newEmail = prompt(
                `Usuario: ${user.username}\n` +
                `Email actual: ${user.email}\n\n` +
                `El email actual ya existe en el sistema de autenticación.\n` +
                `Ingrese un nuevo email para este usuario:`,
                user.email
            );

            if (!newEmail || newEmail === user.email) {
                alert('No se realizaron cambios');
                return;
            }

            // Verificar que el nuevo email no esté en uso
            const emailExists = window.users.find(u => u.email === newEmail && u.id !== userId);
            if (emailExists) {
                alert('El nuevo email ya está en uso por otro usuario');
                return;
            }

                try {
                    // Actualizar el email en Firestore
                    await window.db.collection('users').doc(userId).update({
                        email: newEmail,
                        authStatus: 'active', // Marcar como resuelto
                    note: 'Problema de autenticación resuelto - email actualizado',
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                alert('Email actualizado correctamente. El usuario ahora puede iniciar sesión.');
                
                // Recargar datos
                await window.loadUsers();
                window.updateStats();
                
            } catch (error) {
                console.error('Error actualizando usuario:', error);
                alert('Error al actualizar el usuario: ' + error.message);
            }
        }

        // Función para filtrar usuarios
        function filterUsers() {
            const searchInput = document.getElementById('users-search');
            const showInactive = document.getElementById('show-inactive-users').checked;
            const filter = searchInput.value.toLowerCase();
            const tbody = document.getElementById('users-table-body');
            const rows = tbody.getElementsByTagName('tr');

            for (let row of rows) {
                const text = row.textContent.toLowerCase();
                const statusBadge = row.querySelector('.status-badge');
                const isInactive = statusBadge && statusBadge.classList.contains('inactive');
                
                // Aplicar filtro de búsqueda
                const matchesSearch = text.includes(filter);
                
                // Aplicar filtro de estado
                const shouldShow = matchesSearch && (showInactive || !isInactive);
                
                row.style.display = shouldShow ? '' : 'none';
            }
        }

        // Hacer funciones globales
        window.loadSchools = loadSchools;
        window.loadTeachers = loadTeachers;
        window.loadUsers = loadUsers;
        window.loadSchoolsTable = loadSchoolsTable;
        window.loadTeachersTable = loadTeachersTable;
        window.loadUsersTable = loadUsersTable;
        window.updateStats = updateStats;
        window.filterUsers = filterUsers;
    </script>

    <!-- Script principal -->
    <script>
        // Variables globales
        window.schools = [];
        window.teachers = [];
        window.users = [];
        
        // Función auxiliar para obtener nombres de escuelas por IDs
        window.getSchoolNames = function(schoolIds) {
            if (!window.schools || !schoolIds) return [];
            
            return schoolIds.map(id => {
                const school = window.schools.find(s => s.id === id);
                return school ? (school.nombreInstitucion || school.name) : `Escuela ${id}`;
            });
        }

        // Función auxiliar para obtener nombre del administrador por ID
        window.getAdminName = function(adminId) {
            if (!adminId || !window.users) return 'No asignado';
            
            const admin = window.users.find(u => u.id === adminId);
            if (admin) {
                return `${admin.fullName || admin.name || admin.username} (${admin.email})`;
            }
            return 'Administrador no encontrado';
        }
        
        // Función para controlar permisos de navegación
        function initializeUserPermissions() {
            const currentUser = window.currentUser;
            console.log('Current user:', currentUser);
            
            if (!currentUser) {
                console.log('No current user found, using default permissions');
                // Si no hay usuario, mostrar mensajería por defecto
                showSection('messaging');
                return;
            }
            
            const navItems = document.querySelectorAll('.nav-item');
            
            // Definir permisos por tipo de usuario
            const permissions = {
                soporte: ['messaging', 'dashboard', 'schools', 'teachers', 'users', 'reports', 'support'],
                responsable: ['messaging', 'dashboard', 'schools', 'teachers'],
                docente: ['messaging', 'dashboard'],
                secretaria: ['messaging', 'dashboard']
            };
            
            const userPermissions = permissions[currentUser.type] || [];
            console.log('User permissions:', userPermissions);
            
            // Mostrar/ocultar elementos de navegación según permisos
            navItems.forEach(item => {
                const onclick = item.getAttribute('onclick');
                if (onclick) {
                    const sectionName = onclick.match(/showSection\('([^']+)'\)/);
                    if (sectionName) {
                        const section = sectionName[1];
                        if (userPermissions.includes(section)) {
                            item.style.display = 'flex';
                        } else {
                            item.style.display = 'none';
                        }
                    }
                }
            });
            
            // Mostrar la primera sección permitida por defecto
            if (userPermissions.length > 0) {
                console.log('Showing section:', userPermissions[0]);
                showSection(userPermissions[0]);
            } else {
                // Fallback: mostrar mensajería
                showSection('messaging');
            }
        }
        
        // Función para mostrar secciones
        function showSection(sectionName) {
            // Ocultar todas las secciones
            const sections = document.querySelectorAll('.section');
            sections.forEach(section => section.style.display = 'none');
            
            // Mostrar la sección seleccionada
            const targetSection = document.getElementById(sectionName + '-section');
            if (targetSection) {
                targetSection.style.display = 'block';
            }
            
            // Actualizar navegación activa
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                item.classList.remove('active');
                if (item.getAttribute('onclick') === `showSection('${sectionName}')`) {
                    item.classList.add('active');
                }
            });
            
            // Mostrar/ocultar botón de agregar según la sección
            const addBtn = document.getElementById('add-btn');
            // No mostrar botón en el header para ninguna sección
                addBtn.style.display = 'none';
            
            // Actualizar título y descripción
            const titles = {
                dashboard: { title: 'Dashboard', desc: 'Panel principal del sistema administrativo' },
                schools: { title: 'Gestión de Escuelas', desc: 'Administrar escuelas y sus datos' },
                teachers: { title: 'Gestión de Docentes', desc: 'Gestionar información de docentes' },
                users: { title: 'Gestión de Usuarios', desc: 'Administrar usuarios del sistema' },
                messaging: { title: 'Mensajería', desc: 'Comunicación con escuelas y docentes' },
                reports: { title: 'Reportes', desc: 'Generar reportes del sistema' },
                support: { title: 'Soporte Técnico', desc: 'Gestionar solicitudes de soporte' }
            };
            
            document.getElementById('section-title').textContent = titles[sectionName].title;
            document.getElementById('section-description').textContent = titles[sectionName].desc;
        }
        
        // Funciones de modal
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'flex';
                
                // Si es el modal de docentes y no estamos editando, resetear el formulario
                if (modalId === 'teacher-modal' && !window.editingTeacherId) {
                    resetTeacherForm();
                }
                
                // Si es el modal de escuelas y no estamos editando, resetear el formulario
                if (modalId === 'school-modal' && !window.editingSchoolId) {
                    resetSchoolForm();
                }
                
                // Si es el modal de usuarios y no estamos editando, resetear el formulario
                if (modalId === 'user-modal' && !window.editingUserId) {
                    resetUserForm();
                    window.loadSchoolsListForUser();
                } else if (modalId === 'user-modal' && window.editingUserId) {
                    window.loadSchoolsListForUser();
                }
            }
        }
        
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'none';
                
                // Si es el modal de docentes, resetear el formulario al cerrar
                if (modalId === 'teacher-modal') {
                    resetTeacherForm();
                }
                
                // Si es el modal de escuelas, resetear el formulario al cerrar
                if (modalId === 'school-modal') {
                    resetSchoolForm();
                }
                
                // Si es el modal de usuarios, resetear el formulario al cerrar
                if (modalId === 'user-modal') {
                    resetUserForm();
                }
            }
        }
        
        // Función de logout
        async function logout() {
            if (confirm('¿Estás seguro de que quieres cerrar sesión?')) {
                try {
                    // Actualizar estado offline
                    if (window.auth.currentUser) {
                        await window.db.collection('users').doc(window.auth.currentUser.uid).update({
                            online: false,
                            lastSeen: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }
                    
                    await window.auth.signOut();
                    window.location.href = 'login.html';
                } catch (error) {
                    console.error('Error al cerrar sesión:', error);
                    window.location.href = 'login.html';
                }
            }
        }

        // Cerrar modal al hacer clic fuera
        window.addEventListener('click', function(event) {
            const modal = document.getElementById('logout-modal');
            if (event.target === modal) {
                closeLogoutModal();
            }
            
            const successModal = document.getElementById('success-modal');
            if (event.target === successModal) {
                closeSuccessModal();
            }
        });

        // Función para mostrar el modal de confirmación exitosa
        function showSuccessModal(options) {
            const modal = document.getElementById('success-modal');
            const title = document.getElementById('success-modal-title');
            const message = document.getElementById('success-modal-message');
            const details = document.getElementById('success-modal-details');
            
            // Configurar contenido
            title.textContent = options.title || '¡Operación exitosa!';
            message.textContent = options.message || 'Los datos se han guardado correctamente.';
            
            // Limpiar clases anteriores
            modal.className = 'success-modal';
            
            // Agregar clase específica según el tipo
            if (options.type) {
                modal.classList.add(options.type);
            }
            
            // Mostrar detalles si existen
            if (options.details && options.details.length > 0) {
                details.innerHTML = options.details.map(detail => 
                    `<p><i class="${detail.icon}"></i><span>${detail.text}</span></p>`
                ).join('');
                details.style.display = 'block';
            } else {
                details.style.display = 'none';
            }
            
            // Mostrar modal
            modal.style.display = 'flex';
            
            // Auto-cerrar después de cierto tiempo si se especifica
            if (options.autoClose !== false) {
                setTimeout(() => {
                    closeSuccessModal();
                }, options.autoCloseDelay || 3000);
            }
        }

        // Función para cerrar el modal de confirmación exitosa
        function closeSuccessModal() {
            const modal = document.getElementById('success-modal');
            modal.style.display = 'none';
        }
        
        document.addEventListener('DOMContentLoaded', function() {
        inicializarValidacionEscuelas();
        inicializarValidacionDocentes();
        inicializarValidacionUsuarios();
        
        // Inicializar la aplicación con permisos y datos
        initializeAppData();
        
        document.getElementById('school-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            if (!validarFormularioEscuela()) {
                alert('Por favor, corrija los errores en el formulario antes de continuar');
                return;
            }
            
            try {
                window.ensureFirebaseInitialized();
                } catch (error) {
                alert(error.message);
                return;
            }
            
            try {
                const nivelesSelect = document.getElementById('school-nivel');
                const nivelesEducativos = Array.from(nivelesSelect.selectedOptions).map(option => option.value);
                
                const turnosSelect = document.getElementById('school-turnos');
                const turnos = Array.from(turnosSelect.selectedOptions).map(option => option.value);

                const schoolData = {
                    nombreInstitucion: document.getElementById('school-nombre').value,
                    direccion: {
                        calle: document.getElementById('school-calle').value,
                        ciudad: document.getElementById('school-ciudad').value,
                        provincia: document.getElementById('school-provincia').value
                    },
                    telefonoContacto: document.getElementById('school-telefono').value,
                    correoInstitucional: document.getElementById('school-correo').value,
                    nivelEducativo: nivelesEducativos,
                    administradorResponsable: document.getElementById('school-admin').value,
                    estado: document.getElementById('school-estado').value || 'activa',
                    turnos: turnos,
                    cue: document.getElementById('school-cue').value || null,
                    cantidadDocentes: parseInt(document.getElementById('school-docentes').value) || 0
                };

                if (window.editingSchoolId) {
                    // EDITAR escuela existente
                    await window.db.collection('schools').doc(window.editingSchoolId).update({
                        ...schoolData,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    showSuccessModal({
                        type: 'school-added',
                        title: '¡Escuela actualizada!',
                        message: 'Los datos de la escuela se han actualizado correctamente.',
                        details: [
                            { icon: 'fas fa-school', text: `<strong>Escuela:</strong> ${schoolData.nombreInstitucion}` },
                            { icon: 'fas fa-map-marker-alt', text: `<strong>Ubicación:</strong> ${schoolData.direccion.ciudad}, ${schoolData.direccion.provincia}` }
                        ]
                    });
                    delete window.editingSchoolId;
                } else {
                    // CREAR nueva escuela
                    await window.db.collection('schools').add({
                        ...schoolData,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    showSuccessModal({
                        type: 'school-added',
                        title: '¡Escuela agregada!',
                        message: 'La nueva escuela se ha registrado exitosamente en el sistema.',
                        details: [
                            { icon: 'fas fa-school', text: `<strong>Escuela:</strong> ${schoolData.nombreInstitucion}` },
                            { icon: 'fas fa-graduation-cap', text: `<strong>Niveles:</strong> ${schoolData.nivelEducativo.join(', ')}` },
                            { icon: 'fas fa-map-marker-alt', text: `<strong>Ubicación:</strong> ${schoolData.direccion.ciudad}, ${schoolData.direccion.provincia}` }
                        ]
                    });
                }
                
                    await window.loadSchools();
                    window.updateStats();
                closeModal('school-modal');
                resetSchoolForm();
                
            } catch (error) {
                console.error('Error al procesar escuela:', error);
                alert('Error al procesar escuela: ' + error.message);
            }
        });
        
        document.getElementById('teacher-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!validarFormularioDocente()) {
                alert('Por favor, corrija los errores en el formulario antes de continuar');
                return;
            }
            
            try {
                window.ensureFirebaseInitialized();
            } catch (error) {
                alert(error.message);
                return;
            }
            
            try {
                const escuelasAsignadas = window.selectedTeacherSchoolIds || [];
                const materiasText = document.getElementById('teacher-materias').value;
                const materias = materiasText ? materiasText.split(',').map(m => m.trim()).filter(m => m) : [];
                const usuario = document.getElementById('teacher-usuario').value;
                
                const teacherData = {
                    usuario: usuario,
                    nombre: document.getElementById('teacher-nombre').value,
                    apellido: document.getElementById('teacher-apellido').value,
                    correo: document.getElementById('teacher-correo').value,
                    contraseña: document.getElementById('teacher-contraseña').value,
                    rol: document.getElementById('teacher-rol').value,
                    telefono: document.getElementById('teacher-telefono').value,
                    dni: document.getElementById('teacher-dni').value,
                    escuelasAsignadas: escuelasAsignadas,
                    materias: materias,
                    estado: document.getElementById('teacher-estado').value || 'activo'
                };

                if (window.editingTeacherId) {
                    // EDITAR docente existente
                    const teacherRef = window.db.collection('teachers').doc(window.editingTeacherId);
                    
                    // Preparar datos para actualización (sin contraseña si está vacía)
                    const updateData = {
                        escuelasAsignadas: teacherData.escuelasAsignadas,
                        nombre: teacherData.nombre,
                        apellido: teacherData.apellido,
                        correo: teacherData.correo,
                        rol: teacherData.rol,
                        materias: teacherData.materias,
                        telefono: teacherData.telefono,
                        estado: teacherData.estado,
                        dni: teacherData.dni,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                    if (teacherData.contraseña && teacherData.contraseña.trim()) {
                        updateData.contraseña = teacherData.contraseña;
                    }
                    
                    await teacherRef.update(updateData);
                    
                    showSuccessModal({
                        type: 'teacher-added',
                        title: '¡Docente actualizado!',
                        message: 'Los datos del docente se han actualizado correctamente.',
                        details: [
                            { icon: 'fas fa-chalkboard-teacher', text: `<strong>Docente:</strong> ${teacherData.nombre} ${teacherData.apellido}` },
                            { icon: 'fas fa-id-card', text: `<strong>DNI:</strong> ${teacherData.dni}` },
                            { icon: 'fas fa-envelope', text: `<strong>Email:</strong> ${teacherData.correo}` }
                        ]
                    });
                    delete window.editingTeacherId;
                } else {
                    const existingTeacher = window.teachers.find(t => t.usuario === usuario);
                    if (existingTeacher) {
                        alert('Ya existe un docente con este usuario. Por favor, elija otro.');
                        return;
                    }

                    await window.db.collection('teachers').add({
                        usuario: teacherData.usuario,
                        escuelasAsignadas: teacherData.escuelasAsignadas,
                        nombre: teacherData.nombre,
                        apellido: teacherData.apellido,
                        correo: teacherData.correo,
                        contraseña: teacherData.contraseña, // En producción debería estar hasheada
                        rol: teacherData.rol,
                        materias: teacherData.materias,
                        telefono: teacherData.telefono,
                        estado: teacherData.estado,
                        fechaAlta: firebase.firestore.FieldValue.serverTimestamp(),
                        dni: teacherData.dni,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    showSuccessModal({
                        type: 'teacher-added',
                        title: '¡Docente agregado!',
                        message: 'El nuevo docente se ha registrado exitosamente en el sistema.',
                        details: [
                            { icon: 'fas fa-chalkboard-teacher', text: `<strong>Docente:</strong> ${teacherData.nombre} ${teacherData.apellido}` },
                            { icon: 'fas fa-user', text: `<strong>Usuario:</strong> ${teacherData.usuario}` },
                            { icon: 'fas fa-school', text: `<strong>Escuelas:</strong> ${escuelasAsignadas.length} asignada(s)` }
                        ]
                    });
                }
                
                    await window.loadTeachers();
                    window.updateStats();
                closeModal('teacher-modal');
                resetTeacherForm();
                
            } catch (error) {
                console.error('Error al procesar docente:', error);
                alert('Error al procesar docente: ' + error.message);
            }
        });

            // Indicador de fortaleza de contraseña
            const passwordInput = document.getElementById('user-password');
            const passwordStrength = document.querySelector('.password-strength');
            
            if (passwordInput && passwordStrength) {
                passwordInput.addEventListener('input', function() {
                    const password = this.value;
                    const strength = calculatePasswordStrength(password);
                    
                    // Remover clases previas
                    passwordStrength.classList.remove('weak', 'medium', 'strong');
                    
                    // Agregar clase según fortaleza
                    if (password.length > 0) {
                        passwordStrength.classList.add(strength);
                    }
                });
            }
            
            // Función para calcular la fortaleza de la contraseña
            function calculatePasswordStrength(password) {
                if (password.length === 0) return '';
                
                let strength = 0;
                
                // Longitud
                if (password.length >= 6) strength++;
                if (password.length >= 10) strength++;
                
                // Contiene números
                if (/\d/.test(password)) strength++;
                
                // Contiene minúsculas y mayúsculas
                if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength++;
                
                // Contiene caracteres especiales
                if (/[^A-Za-z0-9]/.test(password)) strength++;
                
                // Clasificar fortaleza
                if (strength <= 2) return 'weak';
                if (strength <= 3) return 'medium';
                return 'strong';
            }

            document.getElementById('user-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                if (!validarFormularioUsuario()) {
                    alert('Por favor, corrija los errores en el formulario antes de continuar');
                    return;
                }
                
                try {
                    window.ensureFirebaseInitialized();
                } catch (error) {
                    alert(error.message);
                    return;
                }
                
                try {
                    const username = document.getElementById('username').value;

                    const userData = {
                        username: username,
                        fullName: document.getElementById('user-fullname').value,
                        email: document.getElementById('user-email').value,
                        type: document.getElementById('user-type').value,
                        schools: window.selectedSchoolIds || [],
                        status: 'Activo'
                    };

                    if (window.editingUserId) {
                        // EDITAR usuario existente
                        const userRef = window.db.collection('users').doc(window.editingUserId);
                        
                        // Preparar datos para actualización
                        const updateData = {
                            fullName: userData.fullName,
                            email: userData.email,
                            type: userData.type,
                            schools: window.selectedSchoolIds || [],
                            status: userData.status,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    };

                        const newPassword = document.getElementById('user-password').value;
                        if (newPassword && newPassword.trim()) {
                            updateData.password = newPassword;
                        }
                        
                        await userRef.update(updateData);
                        
                        showSuccessModal({
                            type: 'user-added',
                            title: '¡Usuario actualizado!',
                            message: 'Los datos del usuario se han actualizado correctamente.',
                            details: [
                                { icon: 'fas fa-user', text: `<strong>Usuario:</strong> ${userData.username}` },
                                { icon: 'fas fa-id-badge', text: `<strong>Nombre:</strong> ${userData.fullName}` },
                                { icon: 'fas fa-user-tag', text: `<strong>Tipo:</strong> ${userData.type}` }
                            ]
                        });
                        delete window.editingUserId;
                    } else {
                        const existingUser = window.users.find(u => u.username === username);
                        if (existingUser) {
                            alert('Ya existe un usuario con este nombre de usuario. Por favor, elija otro.');
                            return;
                        }

                        const password = document.getElementById('user-password').value;
                        if (!password) {
                            alert('La contraseña es requerida para nuevos usuarios');
                            return;
                        }

                        const email = userData.email;
                        const existingEmail = window.users.find(u => u.email === email);
                        if (existingEmail) {
                            alert('Ya existe un usuario con este email. Por favor, use un email diferente.');
                            return;
                        }
                        
                        try {
                            // Crear usuario en Firebase Auth primero
                            const userCredential = await window.auth.createUserWithEmailAndPassword(email, password);
                    
                            const firebaseUser = userCredential.user;

                            // Actualizar el perfil del usuario en Firebase Auth
                            await firebaseUser.updateProfile({
                                displayName: userData.fullName
                            });

                            // Guardar datos adicionales en Firestore
                            await window.db.collection('users').doc(firebaseUser.uid).set({
                                ...userData,
                                uid: firebaseUser.uid, // ID de Firebase Auth
                                password: password, // En producción debería estar hasheada
                                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                            
                            showSuccessModal({
                                type: 'user-added',
                                title: '¡Usuario creado exitosamente!',
                                message: 'El usuario se ha registrado correctamente con credenciales de autenticación.',
                                details: [
                                    { icon: 'fas fa-user', text: `<strong>Usuario:</strong> ${userData.username}` },
                                    { icon: 'fas fa-id-badge', text: `<strong>Nombre:</strong> ${userData.fullName}` },
                                    { icon: 'fas fa-envelope', text: `<strong>Email:</strong> ${userData.email}` },
                                    { icon: 'fas fa-check-circle', text: '<strong>Autenticación:</strong> Credenciales creadas' }
                                ]
                            });
                            
                        } catch (authError) {
                            console.error('Error de autenticación:', authError);
                            
                            if (authError.code === 'auth/email-already-in-use') {
                                const userChoice = confirm(
                                    'El email ya está registrado en el sistema de autenticación.\n\n' +
                                    '¿Desea continuar y crear el usuario solo en la base de datos local?\n\n' +
                                    'SÍ: Crear usuario en base de datos (sin credenciales de login)\n' +
                                    'NO: Cancelar y usar un email diferente'
                                );
                                
                                if (userChoice) {
                                    // Crear usuario solo en Firestore sin credenciales de Auth
                                    await window.db.collection('users').add({
                                        ...userData,
                                        password: password, // En producción debería estar hasheada
                                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                                        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                                        authStatus: 'pending', // Marcar que necesita credenciales
                                        note: 'Usuario creado sin credenciales de autenticación - email ya existe'
                                    });
                                    
                                    showSuccessModal({
                                        type: 'user-added',
                                        title: '⚠️ Usuario agregado con limitaciones',
                                        message: 'El usuario se ha guardado en la base de datos, pero no podrá iniciar sesión hasta resolver el conflicto de email.',
                                        details: [
                                            { icon: 'fas fa-user', text: `<strong>Usuario:</strong> ${userData.username}` },
                                            { icon: 'fas fa-id-badge', text: `<strong>Nombre:</strong> ${userData.fullName}` },
                                            { icon: 'fas fa-exclamation-triangle', text: '<strong>Estado:</strong> Sin credenciales de autenticación' }
                                        ],
                                        autoCloseDelay: 5000
                                    });
                                } else {
                                    alert('Creación de usuario cancelada. Por favor, use un email diferente.');
                                    return;
                                }
                            } else if (authError.code === 'auth/weak-password') {
                                alert('La contraseña es muy débil. Por favor, use una contraseña más segura (mínimo 6 caracteres).');
                                return;
                            } else if (authError.code === 'auth/invalid-email') {
                                alert('El email no es válido. Por favor, verifique el formato del email.');
                                return;
                            } else {
                                throw authError; // Re-lanzar otros errores
                            }
                        }
                    }
                    
                    await window.loadUsers();
                    window.updateStats();
                    closeModal('user-modal');
                    resetUserForm();
                    
                } catch (error) {
                    console.error('Error al procesar usuario:', error);
                    alert('Error al procesar usuario: ' + error.message);
                }
            });
        });

        // Funciones de edición y eliminación (placeholder)
        // Ver detalles de una escuela
        window.viewSchool = function(id) {
            const school = window.schools.find(s => s.id === id);
            if (!school) {
                alert('Escuela no encontrada');
                return;
            }
            
            // Llenar los datos en el modal
            document.getElementById('detail-school-nombre').textContent = school.nombreInstitucion || school.name || 'N/A';
            document.getElementById('detail-school-cue').textContent = school.cue || 'No especificado';
            document.getElementById('detail-school-docentes').textContent = school.cantidadDocentes || school.teachers || 0;
            
            // Estado con badge de color
            const estadoElement = document.getElementById('detail-school-estado');
            const estado = school.estado || school.status?.toLowerCase() || 'activa';
            estadoElement.innerHTML = `<span class="status-badge ${estado === 'activa' ? 'active' : 'inactive'}">${estado}</span>`;
            
            // Dirección completa
            const direccionCompleta = school.direccion 
                ? `${school.direccion.calle || ''}, ${school.direccion.ciudad || ''}, ${school.direccion.provincia || ''}`.replace(/^,\s*|,\s*$/g, '').replace(/,\s*,/g, ',')
                : school.address || 'N/A';
            document.getElementById('detail-school-direccion').textContent = direccionCompleta;
            
            // Información de contacto
            document.getElementById('detail-school-telefono').textContent = school.telefonoContacto || school.phone || 'N/A';
            document.getElementById('detail-school-correo').textContent = school.correoInstitucional || school.email || 'N/A';
            
            // Niveles educativos
            const nivelesElement = document.getElementById('detail-school-niveles');
            if (school.nivelEducativo && school.nivelEducativo.length > 0) {
                nivelesElement.innerHTML = school.nivelEducativo.map(nivel => 
                    `<span class="level-tag"><i class="fas fa-graduation-cap"></i> ${nivel.charAt(0).toUpperCase() + nivel.slice(1)}</span>`
                ).join('');
            } else {
                nivelesElement.innerHTML = '<span class="no-data">Sin niveles definidos</span>';
            }
            
            // Turnos
            const turnosElement = document.getElementById('detail-school-turnos');
            if (school.turnos && school.turnos.length > 0) {
                turnosElement.innerHTML = school.turnos.map(turno => 
                    `<span class="shift-tag"><i class="fas fa-clock"></i> ${turno.charAt(0).toUpperCase() + turno.slice(1)}</span>`
                ).join('');
            } else {
                turnosElement.innerHTML = '<span class="no-data">Sin turnos definidos</span>';
            }
            
            // Administrador responsable
            const adminName = getAdminName(school.administradorResponsable);
            document.getElementById('detail-school-admin').textContent = adminName;
            
            // Guardar el ID de la escuela para la función de editar desde detalles
            window.currentSchoolDetailsId = id;
            
            // Mostrar el modal
            openModal('school-details-modal');
        }
        
        // Función para editar desde el modal de detalles de escuela
        window.editSchoolFromDetails = function() {
            if (window.currentSchoolDetailsId) {
                closeModal('school-details-modal');
                editSchool(window.currentSchoolDetailsId);
            }
        }

        window.editSchool = async function(id) {
            try {
                const school = window.schools.find(s => s.id === id);
                if (!school) {
                    alert('Escuela no encontrada');
                    return;
                }
                
                console.log('🔧 Editando escuela:', school);
                
                // Guardar el ID para la actualización ANTES de cualquier otra cosa
                window.editingSchoolId = id;
                console.log('✅ ID de edición guardado:', window.editingSchoolId);
                
                // Cargar administradores ANTES de abrir el modal
                await window.loadAdminsInSelect(true);
                console.log('✅ Administradores cargados');
                
                // Ahora abrir el modal (no se reseteará porque editingSchoolId ya está definido)
                openModal('school-modal');
                console.log('✅ Modal abierto');
                
                // Cambiar el título del modal y el botón
                document.querySelector('#school-modal .modal-header h3').textContent = 'Editar Escuela';
                document.querySelector('#school-modal .btn-primary').textContent = 'Actualizar Escuela';
                
                // Asegurar que todos los campos están habilitados
                const formInputs = document.querySelectorAll('#school-form input, #school-form select');
                formInputs.forEach(input => {
                    input.disabled = false;
                    input.readOnly = false;
                });
                console.log('✅ Todos los campos habilitados');
            
            // Usar setTimeout para asegurar que el DOM está listo
            setTimeout(() => {
                console.log('📝 Llenando campos del formulario...');
                
                // Limpiar cualquier error previo del formulario
                limpiarErroresFormulario('school-form');
                
                // Rellenar el formulario con los datos existentes
                const nombreInput = document.getElementById('school-nombre');
                const calleInput = document.getElementById('school-calle');
                const ciudadInput = document.getElementById('school-ciudad');
                const provinciaInput = document.getElementById('school-provincia');
                const telefonoInput = document.getElementById('school-telefono');
                const correoInput = document.getElementById('school-correo');
                const cueInput = document.getElementById('school-cue');
                const docentesInput = document.getElementById('school-docentes');
                const estadoInput = document.getElementById('school-estado');
                
                // Log para diagnóstico
                console.log('🔍 Estado de campos antes de llenar:');
                console.log('- nombreInput:', nombreInput ? 'Encontrado' : 'NO ENCONTRADO');
                console.log('- nombreInput.disabled:', nombreInput?.disabled);
                console.log('- nombreInput.readOnly:', nombreInput?.readOnly);
                
                if (nombreInput) {
                    nombreInput.value = school.nombreInstitucion || school.name || '';
                    console.log('✅ Nombre llenado:', nombreInput.value);
                }
                if (calleInput) calleInput.value = school.direccion?.calle || '';
                if (ciudadInput) ciudadInput.value = school.direccion?.ciudad || '';
                if (provinciaInput) provinciaInput.value = school.direccion?.provincia || '';
                if (telefonoInput) telefonoInput.value = school.telefonoContacto || school.phone || '';
                if (correoInput) correoInput.value = school.correoInstitucional || school.email || '';
                if (cueInput) cueInput.value = school.cue || '';
                if (docentesInput) docentesInput.value = school.cantidadDocentes || school.teachers || 0;
                if (estadoInput) estadoInput.value = school.estado || school.status?.toLowerCase() || 'activa';
                
                console.log('✅ Campos básicos llenados');
                
                // Seleccionar el administrador responsable
                const adminSelect = document.getElementById('school-admin');
                if (adminSelect && school.administradorResponsable) {
                    adminSelect.value = school.administradorResponsable;
                    console.log('Administrador seleccionado:', school.administradorResponsable);
                }
                
                // Seleccionar niveles educativos
                const nivelesSelect = document.getElementById('school-nivel');
                if (school.nivelEducativo && nivelesSelect) {
                    Array.from(nivelesSelect.options).forEach(option => {
                        option.selected = school.nivelEducativo.includes(option.value);
                    });
                    console.log('Niveles educativos seleccionados:', school.nivelEducativo);
                }
                
                // Seleccionar turnos
                const turnosSelect = document.getElementById('school-turnos');
                if (school.turnos && turnosSelect) {
                    Array.from(turnosSelect.options).forEach(option => {
                        option.selected = school.turnos.includes(option.value);
                    });
                    console.log('Turnos seleccionados:', school.turnos);
                }
                
                console.log('✅ Formulario completamente llenado');
            }, 150);
            } catch (error) {
                console.error('❌ Error al editar escuela:', error);
                alert('Error al cargar los datos de la escuela: ' + error.message);
            }
        }

        // Función para resetear el formulario de escuelas
        function resetSchoolForm() {
            document.getElementById('school-form').reset();
            limpiarErroresFormulario('school-form');
            document.querySelector('#school-modal .modal-header h3').textContent = 'Agregar Escuela';
            document.querySelector('#school-modal .btn-primary').textContent = 'Guardar Escuela';
            delete window.editingSchoolId;
            
            // Asegurar que todos los campos están habilitados
            const formInputs = document.querySelectorAll('#school-form input, #school-form select');
            formInputs.forEach(input => {
                input.disabled = false;
                input.readOnly = false;
            });
            
            // Recargar el select de administradores para aplicar la lógica de auto-asignación
            window.loadAdminsInSelect();
        }
        
        window.toggleSchoolStatus = async function(id) {
            const school = window.schools.find(s => s.id === id);
            if (!school) {
                alert('Escuela no encontrada');
                return;
            }
            
            const currentStatus = school.estado || 'activa';
            const newStatus = currentStatus === 'activa' ? 'inactiva' : 'activa';
            const action = newStatus === 'inactiva' ? 'deshabilitar' : 'habilitar';
            
            const confirmMessage = `¿Estás seguro de que quieres ${action} la escuela "${school.nombreInstitucion || school.name}"?`;
            
            if (confirm(confirmMessage)) {
                try {
                    // Actualizar estado en Firestore
                    await window.db.collection('schools').doc(id).update({
                        estado: newStatus,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    // Recargar datos
                    await window.loadSchools();
                    window.updateStats();
                    
                    alert(`Escuela ${action === 'deshabilitar' ? 'deshabilitada' : 'habilitada'} correctamente`);
                } catch (error) {
                    console.error(`Error al ${action} escuela:`, error);
                    alert(`Error al ${action} la escuela: ` + error.message);
                }
            }
        }

        // Ver detalles de un docente
        function viewTeacher(id) {
            const teacher = window.teachers.find(t => t.id === id);
            if (!teacher) {
                alert('Docente no encontrado');
                return;
            }
            
            // Llenar los datos en el modal
            document.getElementById('detail-usuario').textContent = teacher.usuario || 'N/A';
            document.getElementById('detail-nombre').textContent = `${teacher.nombre || ''} ${teacher.apellido || ''}`.trim() || 'N/A';
            document.getElementById('detail-dni').textContent = teacher.dni || 'N/A';
            document.getElementById('detail-correo').textContent = teacher.correo || teacher.email || 'N/A';
            document.getElementById('detail-telefono').textContent = teacher.telefono || 'N/A';
            
            // Rol con badge de color
            const rolElement = document.getElementById('detail-rol');
            const rol = teacher.rol || 'Sin rol';
            rolElement.innerHTML = `<span class="role-badge ${rol.replace(' ', '_').toLowerCase()}">${rol}</span>`;
            
            // Estado con badge de color
            const estadoElement = document.getElementById('detail-estado');
            const estado = teacher.estado || 'activo';
            estadoElement.innerHTML = `<span class="status-badge ${estado === 'activo' ? 'active' : 'inactive'}">${estado}</span>`;
            
            // Fecha de alta
            const fechaAlta = teacher.fechaAlta 
                ? new Date(teacher.fechaAlta.seconds * 1000).toLocaleDateString('es-ES', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                })
                : 'N/A';
            document.getElementById('detail-fecha').textContent = fechaAlta;
            
            // Escuelas asignadas
            const escuelasElement = document.getElementById('detail-escuelas');
            if (teacher.escuelasAsignadas && teacher.escuelasAsignadas.length > 0) {
                const escuelasNames = getSchoolNames(teacher.escuelasAsignadas);
                escuelasElement.innerHTML = escuelasNames.map(name => 
                    `<span class="school-tag"><i class="fas fa-school"></i> ${name}</span>`
                ).join('');
            } else {
                escuelasElement.innerHTML = '<span class="no-data">Sin escuelas asignadas</span>';
            }
            
            // Materias/Asignaturas
            const materiasElement = document.getElementById('detail-materias');
            if (teacher.materias && teacher.materias.length > 0) {
                materiasElement.innerHTML = teacher.materias.map(materia => 
                    `<span class="subject-tag"><i class="fas fa-book"></i> ${materia}</span>`
                ).join('');
            } else {
                materiasElement.innerHTML = '<span class="no-data">Sin materias asignadas</span>';
            }
            
            // Guardar el ID del docente para la función de editar desde detalles
            window.currentTeacherDetailsId = id;
            
            // Mostrar el modal
            openModal('teacher-details-modal');
        }
        
        // Función para editar desde el modal de detalles
        function editTeacherFromDetails() {
            if (window.currentTeacherDetailsId) {
                closeModal('teacher-details-modal');
                editTeacher(window.currentTeacherDetailsId);
            }
        }
        
        function editTeacher(id) {
            const teacher = window.teachers.find(t => t.id === id);
            if (!teacher) {
                alert('Docente no encontrado');
                return;
            }
            
            // Rellenar el formulario con los datos existentes
            document.getElementById('teacher-usuario').value = teacher.usuario || '';
            document.getElementById('teacher-nombre').value = teacher.nombre || '';
            document.getElementById('teacher-apellido').value = teacher.apellido || '';
            document.getElementById('teacher-correo').value = teacher.correo || teacher.email || '';
            document.getElementById('teacher-contraseña').value = ''; // Por seguridad, no mostrar contraseña
            document.getElementById('teacher-rol').value = teacher.rol || '';
            document.getElementById('teacher-telefono').value = teacher.telefono || '';
            document.getElementById('teacher-dni').value = teacher.dni || '';
            document.getElementById('teacher-estado').value = teacher.estado || 'activo';
            
            // Seleccionar escuelas asignadas
            if (teacher.escuelasAsignadas) {
                window.selectedTeacherSchoolIds = [...teacher.escuelasAsignadas];
            } else {
                window.selectedTeacherSchoolIds = [];
            }
            
            // Recargar la lista de escuelas con las selecciones
            loadSchoolsInSelect();
            
            // Rellenar materias
            if (teacher.materias && teacher.materias.length > 0) {
                document.getElementById('teacher-materias').value = teacher.materias.join(', ');
            }
            
            // Cambiar el título del modal y el botón
            document.querySelector('#teacher-modal .modal-header h3').textContent = 'Editar Docente';
            document.querySelector('#teacher-modal .btn-primary').textContent = 'Actualizar Docente';
            
            // Deshabilitar el campo usuario para evitar duplicados
            document.getElementById('teacher-usuario').disabled = true;
            
            // Guardar el ID para la actualización
            window.editingTeacherId = id;
            
            // Abrir el modal
            openModal('teacher-modal');
        }

        // Función para resetear el formulario de docentes
        function resetTeacherForm() {
            document.getElementById('teacher-form').reset();
            limpiarErroresFormulario('teacher-form');
            document.getElementById('teacher-usuario').disabled = false;
            document.querySelector('#teacher-modal .modal-header h3').textContent = 'Agregar Docente';
            document.querySelector('#teacher-modal .btn-primary').textContent = 'Guardar Docente';
            delete window.editingTeacherId;
            
            // Limpiar escuelas seleccionadas
            window.selectedTeacherSchoolIds = [];
            loadSchoolsInSelect();
        }
        
        
        async function toggleTeacherStatus(id) {
            const teacher = window.teachers.find(t => t.id === id);
            if (!teacher) {
                alert('Docente no encontrado');
                return;
            }
            
            const currentStatus = teacher.estado || 'activo';
            const newStatus = currentStatus === 'activo' ? 'inactivo' : 'activo';
            const action = newStatus === 'inactivo' ? 'deshabilitar' : 'habilitar';
            
            const confirmMessage = `¿Estás seguro de que quieres ${action} al docente ${teacher.nombre} ${teacher.apellido} (${teacher.usuario})?`;
            
            if (confirm(confirmMessage)) {
                try {
                    // Actualizar estado en Firestore
                    await window.db.collection('teachers').doc(id).update({
                        estado: newStatus,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    // Recargar datos
                    await window.loadTeachers();
                    window.updateStats();
                    
                    alert(`Docente ${action === 'deshabilitar' ? 'deshabilitado' : 'habilitado'} correctamente`);
                } catch (error) {
                    console.error(`Error al ${action} docente:`, error);
                    alert(`Error al ${action} docente: ` + error.message);
                }
            }
        }
        
        // Función helper para formatear tiempo relativo
        function formatTimeAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffSeconds = Math.floor(diffMs / 1000);
            const diffMinutes = Math.floor(diffSeconds / 60);
            const diffHours = Math.floor(diffMinutes / 60);
            const diffDays = Math.floor(diffHours / 24);
            
            let text, timeClass;
            
            if (diffSeconds < 60) {
                text = 'Hace unos segundos';
                timeClass = 'recent'; // Verde
            } else if (diffMinutes < 60) {
                text = `Hace ${diffMinutes} minuto${diffMinutes !== 1 ? 's' : ''}`;
                timeClass = 'recent'; // Verde
            } else if (diffHours < 1) {
                text = 'Hace menos de 1 hora';
                timeClass = 'recent'; // Verde
            } else if (diffHours < 24) {
                text = `Hace ${diffHours} hora${diffHours !== 1 ? 's' : ''}`;
                timeClass = 'today'; // Azul
            } else if (diffDays < 7) {
                text = `Hace ${diffDays} día${diffDays !== 1 ? 's' : ''}`;
                timeClass = 'week'; // Amarillo
            } else {
                // Si es más de 7 días, mostrar fecha completa
                text = date.toLocaleDateString('es-ES', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                timeClass = 'old'; // Gris
            }
            
            return { text, timeClass };
        }
        
        // Ver detalles de un usuario
        function viewUser(id) {
            const user = window.users.find(u => u.id === id);
            if (!user) {
                alert('Usuario no encontrado');
                return;
            }
            
            // Llenar datos del header del perfil
            document.getElementById('detail-user-fullname-header').textContent = user.fullName || user.name || 'Usuario';
            document.getElementById('detail-user-username-header').textContent = user.username || 'N/A';
            document.getElementById('detail-user-type-badge').textContent = user.type || 'Usuario';
            
            // Llenar los datos en el modal
            document.getElementById('detail-user-username').textContent = user.username || 'N/A';
            document.getElementById('detail-user-fullname').textContent = user.fullName || user.name || 'N/A';
            document.getElementById('detail-user-email').textContent = user.email || 'N/A';
            document.getElementById('detail-user-type').textContent = user.type || 'Usuario';
            
            // Estado con indicador visual
            const statusElement = document.getElementById('detail-user-status');
            const status = user.status || 'Activo';
            statusElement.textContent = status;
            statusElement.setAttribute('data-status', status);
            
            // Fechas
            const fechaCreacion = user.createdAt 
                ? new Date(user.createdAt.seconds * 1000).toLocaleDateString('es-ES', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                })
                : 'N/A';
            document.getElementById('detail-user-created').textContent = fechaCreacion;
            
            const fechaActualizacion = user.updatedAt 
                ? new Date(user.updatedAt.seconds * 1000).toLocaleDateString('es-ES', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                })
                : 'N/A';
            document.getElementById('detail-user-updated').textContent = fechaActualizacion;
            
            const accessElement = document.getElementById('detail-user-access');
            if (user.lastAccess) {
                const accessDate = new Date(user.lastAccess.seconds * 1000);
                const { text, timeClass } = formatTimeAgo(accessDate);
                accessElement.textContent = text;
                accessElement.setAttribute('data-time', timeClass);
            } else {
                accessElement.textContent = 'Nunca';
                accessElement.setAttribute('data-time', 'never');
            }
            
            // Guardar el ID del usuario para la función de editar desde detalles
            window.currentUserDetailsId = id;
            
            // Mostrar el modal
            openModal('user-details-modal');
        }
        
        function editUser(id) {
            const user = window.users.find(u => u.id === id);
            if (!user) {
                alert('Usuario no encontrado');
                return;
            }
            
            // Rellenar el formulario con los datos existentes
            document.getElementById('username').value = user.username || '';
            document.getElementById('user-fullname').value = user.fullName || user.name || '';
            document.getElementById('user-email').value = user.email || '';
            document.getElementById('user-type').value = user.type || '';
            // No mostrar la contraseña por seguridad
            document.getElementById('user-password').value = '';
            
            // Cargar escuelas seleccionadas del usuario
            window.selectedSchoolIds = user.schools || [];
            
            // Cambiar el título del modal y el botón
            document.querySelector('#user-modal .modal-header h3').textContent = 'Editar Usuario';
            document.querySelector('#user-modal .btn-primary').textContent = 'Actualizar Usuario';
            
            // Deshabilitar el campo username para evitar duplicados
            document.getElementById('username').disabled = true;
            
            // Hacer la contraseña opcional en edición
            document.getElementById('user-password').required = false;
            const passwordLabel = document.querySelector('label[for="user-password"]');
            if (passwordLabel) {
                passwordLabel.textContent = 'Nueva Contraseña (opcional)';
            }
            
            // Guardar el ID para la actualización
            window.editingUserId = id;
            
            // Abrir el modal
            openModal('user-modal');
        }

        // Función para resetear el formulario de usuarios
        function resetUserForm() {
            document.getElementById('user-form').reset();
            limpiarErroresFormulario('user-form');
            document.getElementById('username').disabled = false;
            document.getElementById('user-password').required = true;
            
            const passwordLabel = document.querySelector('label[for="user-password"]');
            if (passwordLabel) {
                passwordLabel.textContent = 'Contraseña';
            }
            
            // Resetear indicador de fortaleza de contraseña
            const passwordStrength = document.querySelector('.password-strength');
            if (passwordStrength) {
                passwordStrength.classList.remove('weak', 'medium', 'strong');
            }
            
            // Limpiar escuelas seleccionadas
            window.selectedSchoolIds = [];
            document.getElementById('schools-search-input').value = '';
            updateSelectedSchoolsDisplay();
            
            document.querySelector('#user-modal .modal-header h3').textContent = 'Agregar Usuario';
            document.querySelector('#user-modal .btn-primary').textContent = 'Guardar Usuario';
            delete window.editingUserId;
        }

        // Función para editar desde el modal de detalles de usuario
        function editUserFromDetails() {
            if (window.currentUserDetailsId) {
                closeModal('user-details-modal');
                editUser(window.currentUserDetailsId);
            }
        }
        
        async function toggleUserStatus(id) {
            const user = window.users.find(u => u.id === id);
            if (!user) {
                alert('Usuario no encontrado');
                return;
            }
            
            const currentStatus = user.status || 'Activo';
            const newStatus = currentStatus === 'Activo' ? 'Inactivo' : 'Activo';
            const action = newStatus === 'Inactivo' ? 'deshabilitar' : 'habilitar';
            
            const confirmMessage = `¿Estás seguro de que quieres ${action} al usuario "${user.fullName || user.name || user.username}"?`;
            
            if (confirm(confirmMessage)) {
                try {
                    // Actualizar estado en Firestore
                    await window.db.collection('users').doc(id).update({
                        status: newStatus,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    // Recargar datos
                    await window.loadUsers();
                    window.updateStats();
                    
                    alert(`Usuario ${action === 'deshabilitar' ? 'deshabilitado' : 'habilitado'} correctamente`);
                } catch (error) {
                    console.error(`Error al ${action} usuario:`, error);
                    alert(`Error al ${action} usuario: ` + error.message);
                }
            }
        }

  

        // ===== FUNCIONES DE GESTIÓN DE SOPORTE =====
        
        let supportRequests = [];
        let currentSupportRequest = null;

        // Cargar solicitudes de soporte desde Firebase
        async function loadSupportRequests() {
            try {
                const supportRef = collection(window.db, 'support_requests');
                const querySnapshot = await getDocs(supportRef);
                
                supportRequests = [];
                querySnapshot.forEach((doc) => {
                    supportRequests.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });

                // Ordenar por fecha (más recientes primero)
                supportRequests.sort((a, b) => {
                    const dateA = a.createdAt?.toDate() || new Date(a.timestamp);
                    const dateB = b.createdAt?.toDate() || new Date(b.timestamp);
                    return dateB - dateA;
                });

                renderSupportRequests();
                updateSupportStats();
            } catch (error) {
                console.error('Error al cargar solicitudes de soporte:', error);
                document.getElementById('support-requests-list').innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-circle"></i>
                        <p>Error al cargar solicitudes</p>
                    </div>
                `;
            }
        }

        // Renderizar solicitudes
        function renderSupportRequests() {
            const container = document.getElementById('support-requests-list');
            
            if (supportRequests.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-inbox"></i>
                        <p>No hay solicitudes de soporte</p>
                    </div>
                `;
                return;
            }

            const filteredRequests = getFilteredRequests();

            if (filteredRequests.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-filter"></i>
                        <p>No hay solicitudes que coincidan con los filtros</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = filteredRequests.map(request => {
                const date = request.createdAt?.toDate() || new Date(request.timestamp);
                const formattedDate = date.toLocaleString('es-ES', { 
                    day: '2-digit', 
                    month: 'short', 
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                const statusText = {
                    'pending': 'Pendiente',
                    'in_progress': 'En proceso',
                    'resolved': 'Resuelta'
                }[request.status] || 'Pendiente';

                const typeText = {
                    'acceso': 'Problemas de acceso',
                    'tecnico': 'Problema técnico',
                    'cuenta': 'Solicitud de cuenta',
                    'informacion': 'Solicitar información',
                    'otro': 'Otro'
                }[request.type] || request.type;

                const priorityClass = {
                    'alta': 'high',
                    'normal': 'normal',
                    'baja': 'low'
                }[request.priority] || 'normal';

                const statusClass = {
                    'pending': 'pending',
                    'in_progress': 'in-progress',
                    'resolved': 'resolved'
                }[request.status] || 'pending';

                return `
                    <div class="support-request-card ${statusClass}" onclick="viewSupportDetails('${request.id}')">
                        <div class="support-request-header">
                            <div class="support-request-info">
                                <h4>${request.name}</h4>
                                <p class="support-request-type"><i class="fas fa-tag"></i> ${typeText}</p>
                            </div>
                            <div class="support-request-badges">
                                <span class="priority-badge priority-${priorityClass}">${request.priority}</span>
                                <span class="status-badge status-${statusClass}">${statusText}</span>
                            </div>
                        </div>
                        <div class="support-request-body">
                            <p class="support-request-message">${request.message.substring(0, 150)}${request.message.length > 150 ? '...' : ''}</p>
                        </div>
                        <div class="support-request-footer">
                            <span class="support-request-contact">
                                <i class="fas fa-envelope"></i> ${request.email}
                            </span>
                            <span class="support-request-date">
                                <i class="fas fa-calendar"></i> ${formattedDate}
                            </span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Obtener solicitudes filtradas
        function getFilteredRequests() {
            const statusFilter = document.getElementById('status-filter').value;
            const priorityFilter = document.getElementById('priority-filter').value;

            return supportRequests.filter(request => {
                const matchesStatus = statusFilter === 'all' || request.status === statusFilter;
                const matchesPriority = priorityFilter === 'all' || request.priority === priorityFilter;
                return matchesStatus && matchesPriority;
            });
        }

        // Filtrar solicitudes
        function filterSupportRequests() {
            renderSupportRequests();
            updateSupportStats();
        }

        // Actualizar estadísticas
        function updateSupportStats() {
            const pending = supportRequests.filter(r => r.status === 'pending').length;
            const inProgress = supportRequests.filter(r => r.status === 'in_progress').length;
            const resolved = supportRequests.filter(r => r.status === 'resolved').length;

            document.getElementById('pending-count').textContent = pending;
            document.getElementById('in-progress-count').textContent = inProgress;
            document.getElementById('resolved-count').textContent = resolved;
        }

        // Ver detalles de solicitud
        function viewSupportDetails(requestId) {
            const request = supportRequests.find(r => r.id === requestId);
            if (!request) return;

            currentSupportRequest = request;

            // Rellenar modal con información
            document.getElementById('support-detail-name').textContent = request.name || '-';
            document.getElementById('support-detail-email').textContent = request.email || '-';
            document.getElementById('support-detail-phone').textContent = request.phone || 'No proporcionado';
            
            const typeText = {
                'acceso': 'Problemas de acceso',
                'tecnico': 'Problema técnico',
                'cuenta': 'Solicitud de cuenta',
                'informacion': 'Solicitar información',
                'otro': 'Otro'
            }[request.type] || request.type;
            document.getElementById('support-detail-type').textContent = typeText;

            const priorityElem = document.getElementById('support-detail-priority');
            priorityElem.textContent = request.priority.toUpperCase();
            priorityElem.className = 'detail-value priority-badge priority-' + {
                'alta': 'high',
                'normal': 'normal',
                'baja': 'low'
            }[request.priority];

            const statusText = {
                'pending': 'Pendiente',
                'in_progress': 'En proceso',
                'resolved': 'Resuelta'
            }[request.status] || 'Pendiente';
            
            const statusElem = document.getElementById('support-detail-status');
            statusElem.textContent = statusText;
            statusElem.className = 'detail-value status-badge status-' + {
                'pending': 'pending',
                'in_progress': 'in-progress',
                'resolved': 'resolved'
            }[request.status];

            const date = request.createdAt?.toDate() || new Date(request.timestamp);
            const formattedDate = date.toLocaleString('es-ES', { 
                day: '2-digit', 
                month: 'long', 
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            document.getElementById('support-detail-date').textContent = formattedDate;
            document.getElementById('support-detail-message').textContent = request.message;

            // Establecer valor del select
            document.getElementById('support-status-select').value = request.status;

            // Abrir modal
            openModal('support-details-modal');
        }

        // Actualizar estado de solicitud
        async function updateSupportStatus() {
            if (!currentSupportRequest) return;

            const newStatus = document.getElementById('support-status-select').value;
            const requestId = currentSupportRequest.id;

            try {
                const requestRef = db.collection('support_requests').doc(requestId);
                await requestRef.update({
                    status: newStatus,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                // Actualizar en la lista local
                const request = supportRequests.find(r => r.id === requestId);
                if (request) {
                    request.status = newStatus;
                }

                renderSupportRequests();
                updateSupportStats();
                closeModal('support-details-modal');

                alert('Estado actualizado correctamente');
            } catch (error) {
                console.error('Error al actualizar estado:', error);
                alert('Error al actualizar el estado');
            }
        }

        // Refrescar solicitudes
        async function refreshSupportRequests() {
            document.getElementById('support-requests-list').innerHTML = `
                <div class="loading-state">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>Actualizando...</p>
                </div>
            `;
            await loadSupportRequests();
        }

        // Cargar solicitudes cuando se muestre la sección
        const originalShowSection = showSection;
        showSection = function(sectionName) {
            originalShowSection(sectionName);
            if (sectionName === 'support') {
                loadSupportRequests();
            }
            if (sectionName === 'reports') {
                loadReports();
            }
        };

        // ===== SISTEMA DE REPORTES CON GRÁFICOS =====
        
        let chartRoles = null;
        let chartDays = null;
        let chartPriorities = null;

        // Función principal para cargar reportes
        async function loadReports() {
            try {
                window.ensureFirebaseInitialized();
                
                const period = document.getElementById('report-period').value;
                const db = firebase.firestore();
                
                console.log('Cargando reportes para período:', period);
                
                // Calcular fecha de inicio basada en el período
                let startDate = new Date();
                if (period !== 'all') {
                    startDate.setDate(startDate.getDate() - parseInt(period));
                }
                
                // Obtener todas las conversaciones (sin filtro inicial para evitar problemas de índices)
                const snapshot = await db.collection('conversations').get();
                
                console.log('Conversaciones obtenidas:', snapshot.size);
                
                if (snapshot.empty) {
                    console.log('No hay conversaciones en la base de datos');
                    showNoDataMessage();
                    return;
                }
                
                // Procesar y filtrar datos en el cliente
                const conversations = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const timestamp = data.updatedAt || data.createdAt;
                    
                    // Filtrar por período si no es "all"
                    if (period !== 'all' && timestamp) {
                        const convDate = timestamp.toDate();
                        if (convDate >= startDate) {
                            conversations.push({ id: doc.id, ...data });
                        }
                    } else if (period === 'all') {
                        conversations.push({ id: doc.id, ...data });
                    }
                });
                
                console.log('Conversaciones filtradas:', conversations.length);
                
                if (conversations.length === 0) {
                    console.log('No hay conversaciones en el período seleccionado');
                    showNoDataMessage();
                    return;
                }
                
                // Generar estadísticas
                await generateRoleStats(conversations);
                await generateDayStats(conversations);
                await generatePriorityStats(conversations);
                await generateGeneralStats(conversations, parseInt(period) || 365);
                
                console.log('Reportes generados exitosamente');
                
            } catch (error) {
                console.error('Error detallado al cargar reportes:', error);
                console.error('Tipo de error:', error.name);
                console.error('Mensaje:', error.message);
                console.error('Stack:', error.stack);
                
                // Mostrar mensaje más detallado
                let errorMsg = 'Error al cargar los reportes.';
                if (error.code === 'permission-denied') {
                    errorMsg += ' No tienes permisos para acceder a las conversaciones.';
                } else if (error.message.includes('index')) {
                    errorMsg += ' Se requiere configurar un índice en Firestore.';
                } else {
                    errorMsg += ` ${error.message}`;
                }
                
                alert(errorMsg);
                showNoDataMessage();
            }
        }

        // Estadísticas por Rol
        async function generateRoleStats(conversations) {
            try {
                const roleCount = {};
                const db = firebase.firestore();
                
                console.log('Generando estadísticas por rol...');
                
                // Contar conversaciones por rol de los participantes
                for (const conv of conversations) {
                    if (!conv.participants || conv.participants.length === 0) continue;
                    
                    try {
                        // Obtener información de cada participante
                        for (const userId of conv.participants) {
                            const userDoc = await db.collection('usuarios').doc(userId).get();
                            if (userDoc.exists) {
                                const userData = userDoc.data();
                                const role = userData.tipoUsuario || 'Desconocido';
                                roleCount[role] = (roleCount[role] || 0) + 1;
                            }
                        }
                    } catch (error) {
                        console.error('Error al obtener usuario:', userId, error);
                    }
                }
                
                console.log('Conteo de roles:', roleCount);
            
            // Mapear nombres de roles a nombres amigables
            const roleNames = {
                'admin': 'Administrador',
                'responsable': 'Responsable',
                'docente': 'Docente',
                'secretaria': 'Secretaria',
                'soporte': 'Soporte'
            };
            
            const labels = Object.keys(roleCount).map(role => roleNames[role] || role);
            const data = Object.values(roleCount);
            const colors = [
                'rgba(139, 69, 19, 0.8)',     // Marrón - Admin
                'rgba(210, 105, 30, 0.8)',    // Chocolate - Responsable
                'rgba(205, 133, 63, 0.8)',    // Peru - Docente
                'rgba(244, 164, 96, 0.8)',    // Sandy Brown - Secretaria
                'rgba(23, 162, 184, 0.8)'     // Info - Soporte
            ];
            
            // Destruir gráfico anterior si existe
            if (chartRoles) {
                chartRoles.destroy();
            }
            
            // Crear nuevo gráfico
            const ctx = document.getElementById('chartRoles').getContext('2d');
            chartRoles = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Conversaciones por Rol',
                        data: data,
                        backgroundColor: colors,
                        borderColor: colors.map(c => c.replace('0.8', '1')),
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                font: {
                                    size: 12,
                                    family: "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif"
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${label}: ${value} conversaciones (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
            } catch (error) {
                console.error('Error en generateRoleStats:', error);
                // Mostrar gráfico vacío en caso de error
                if (chartRoles) chartRoles.destroy();
            }
        }

        // Estadísticas por Día de la Semana
        async function generateDayStats(conversations) {
            const dayCount = {
                'Domingo': 0,
                'Lunes': 0,
                'Martes': 0,
                'Miércoles': 0,
                'Jueves': 0,
                'Viernes': 0,
                'Sábado': 0
            };
            
            const dayNames = ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'];
            
            conversations.forEach(conv => {
                const timestamp = conv.updatedAt || conv.createdAt;
                if (timestamp) {
                    const date = timestamp.toDate();
                    const dayName = dayNames[date.getDay()];
                    dayCount[dayName]++;
                }
            });
            
            const labels = Object.keys(dayCount);
            const data = Object.values(dayCount);
            
            // Destruir gráfico anterior si existe
            if (chartDays) {
                chartDays.destroy();
            }
            
            // Crear nuevo gráfico
            const ctx = document.getElementById('chartDays').getContext('2d');
            chartDays = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Conversaciones por Día',
                        data: data,
                        backgroundColor: 'rgba(139, 69, 19, 0.7)',
                        borderColor: 'rgba(139, 69, 19, 1)',
                        borderWidth: 2,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.parsed.y} conversaciones`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1,
                                font: {
                                    size: 11
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        x: {
                            ticks: {
                                font: {
                                    size: 11
                                }
                            },
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        // Estadísticas por Prioridad
        async function generatePriorityStats(conversations) {
            const priorityCount = {
                'alta': 0,
                'media': 0,
                'baja': 0,
                'normal': 0
            };
            
            conversations.forEach(conv => {
                // Obtener prioridad del último mensaje o de la conversación
                const priority = (conv.lastMessage && conv.lastMessage.priority) || conv.priority || 'normal';
                priorityCount[priority]++;
            });
            
            const labels = ['Alta', 'Media', 'Baja', 'Normal'];
            const data = [
                priorityCount['alta'],
                priorityCount['media'],
                priorityCount['baja'],
                priorityCount['normal']
            ];
            
            const colors = [
                'rgba(220, 53, 69, 0.8)',   // Rojo - Alta
                'rgba(255, 193, 7, 0.8)',   // Amarillo - Media
                'rgba(40, 167, 69, 0.8)',   // Verde - Baja
                'rgba(108, 117, 125, 0.8)'  // Gris - Normal
            ];
            
            // Destruir gráfico anterior si existe
            if (chartPriorities) {
                chartPriorities.destroy();
            }
            
            // Crear nuevo gráfico
            const ctx = document.getElementById('chartPriorities').getContext('2d');
            chartPriorities = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Conversaciones por Prioridad',
                        data: data,
                        backgroundColor: colors,
                        borderColor: colors.map(c => c.replace('0.8', '1')),
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                font: {
                                    size: 12,
                                    family: "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif"
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                    return `${label}: ${value} conversaciones (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Estadísticas Generales
        async function generateGeneralStats(conversations, days) {
            const total = conversations.length;
            const avgPerDay = (total / days).toFixed(1);
            
            // Calcular rol más activo (basado en participantes en conversaciones)
            const roleCount = {};
            const db = firebase.firestore();
            
            for (const conv of conversations) {
                if (!conv.participants || conv.participants.length === 0) continue;
                
                try {
                    for (const userId of conv.participants) {
                        const userDoc = await db.collection('usuarios').doc(userId).get();
                        if (userDoc.exists) {
                            const userData = userDoc.data();
                            const role = userData.tipoUsuario || 'Desconocido';
                            roleCount[role] = (roleCount[role] || 0) + 1;
                        }
                    }
                } catch (error) {
                    console.error('Error:', error);
                }
            }
            
            let mostActiveRole = 'N/A';
            let maxCount = 0;
            
            for (const [role, count] of Object.entries(roleCount)) {
                if (count > maxCount) {
                    maxCount = count;
                    mostActiveRole = role;
                }
            }
            
            // Mapear nombre del rol
            const roleNames = {
                'admin': 'Administrador',
                'responsable': 'Responsable',
                'docente': 'Docente',
                'secretaria': 'Secretaria',
                'soporte': 'Soporte'
            };
            
            document.getElementById('total-report-messages').textContent = total;
            document.getElementById('avg-daily-messages').textContent = avgPerDay;
            document.getElementById('most-active-role').textContent = roleNames[mostActiveRole] || mostActiveRole;
        }

        // Mostrar mensaje cuando no hay datos
        function showNoDataMessage() {
            document.getElementById('total-report-messages').textContent = '0';
            document.getElementById('avg-daily-messages').textContent = '0';
            document.getElementById('most-active-role').textContent = 'N/A';
            
            // Limpiar gráficos
            if (chartRoles) chartRoles.destroy();
            if (chartDays) chartDays.destroy();
            if (chartPriorities) chartPriorities.destroy();
        }
        
    </script>
</body>
</html>
