<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Panel del Responsable a Cargo - Gesti√≥n de Escuelas y Docentes">
    <meta name="theme-color" content="#8b4513">
    <title>Zephia - Panel Responsable a Cargo</title>
    <link rel="icon" type="image/png" href="img/logo.png">
    <link rel="stylesheet" href="styles-r.css?v=2">
    <link rel="stylesheet" href="styles-messaging.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- Firebase SDK Compat -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <!-- Sistema de Mensajer√≠a -->
    <script src="messaging-service-compat.js"></script>
    <script src="messaging-ui-compat.js"></script>
</head>
<body>
    <div class="admin-container">
        <!-- Sidebar -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <img src="img/logo.png" alt="Zephia Logo" class="logo">
                <h2>Zephia</h2>
                <p class="user-role">Responsable a Cargo</p>
            </div>
            <ul class="nav-menu">
                <li class="nav-item active" onclick="showSection('messaging')">
                    <i class="fas fa-envelope"></i>
                    <span>Mensajer√≠a</span>
                </li>
                <li class="nav-item" onclick="showSection('schools')">
                    <i class="fas fa-school"></i>
                    <span>Mis Escuelas</span>
                </li>
                <li class="nav-item" onclick="showSection('teachers')">
                    <i class="fas fa-chalkboard-teacher"></i>
                    <span>Mis Docentes</span>
                </li>
                <li class="nav-item" onclick="showSection('dashboard')">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Dashboard</span>
                </li>
                <li class="nav-item" onclick="showSection('reports')">
                    <i class="fas fa-chart-bar"></i>
                    <span>Reportes</span>
                </li>
            </ul>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <header class="header">
                <div class="breadcrumb">
                    <h2 id="section-title">Dashboard</h2>
                    <p id="section-description">Panel del Responsable a Cargo</p>
                </div>
                <div class="header-actions">
                    <button class="action-btn logout-btn" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i> Cerrar Sesi√≥n
                    </button>
                </div>
            </header>

            <!-- Dashboard Section -->
            <section id="dashboard-section" class="section" style="display: none;">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-school"></i>
                        </div>
                        <div class="stat-content">
                            <h3 class="stat-number" id="total-schools">0</h3>
                            <p class="stat-label">Mis Escuelas</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-chalkboard-teacher"></i>
                        </div>
                        <div class="stat-content">
                            <h3 class="stat-number" id="total-teachers">0</h3>
                            <p class="stat-label">Mis Docentes</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-envelope"></i>
                        </div>
                        <div class="stat-content">
                            <h3 class="stat-number" id="total-messages">0</h3>
                            <p class="stat-label">Mensajes</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="stat-content">
                            <h3 class="stat-number" id="total-reports">0</h3>
                            <p class="stat-label">Reportes</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Schools Section -->
            <section id="schools-section" class="section" style="display: none;">
                <div class="section-header">
                    <div class="search-container">
                        <i class="fas fa-search"></i>
                        <input type="text" id="schools-search" placeholder="Buscar por nombre, direcci√≥n, nivel..." onkeyup="filterSchools()">
                    </div>
                    <button class="btn-primary" onclick="openModal('school-modal')">
                        <i class="fas fa-plus"></i> Agregar Escuela
                    </button>
                </div>
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>Direcci√≥n</th>
                                <th>Tel√©fono</th>
                                <th>Nivel Educativo</th>
                                <th>Docentes</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="schools-table-body">
                            <!-- Los datos se cargar√°n aqu√≠ -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Teachers Section -->
            <section id="teachers-section" class="section" style="display: none;">
                <div class="section-header">
                    <div class="search-container">
                        <i class="fas fa-search"></i>
                        <input type="text" id="teachers-search" placeholder="Buscar por nombre, usuario, correo, rol..." onkeyup="filterTeachers()">
                    </div>
                    <button class="btn-primary" onclick="openModal('teacher-modal')">
                        <i class="fas fa-plus"></i> Agregar Docente
                    </button>
                </div>
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Usuario</th>
                                <th>Nombre</th>
                                <th>Rol</th>
                                <th>Correo</th>
                                <th>Tel√©fono</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="teachers-table-body">
                            <!-- Los datos se cargar√°n aqu√≠ -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Messaging Section -->
            <section id="messaging-section" class="section" style="display: block;">
                <div class="messaging-wrapper">
                    <!-- Panel Izquierdo: Lista de Conversaciones -->
                    <div class="conversations-panel">
                        <div class="conversations-header">
                            <button class="header-icon-btn" title="Menu">
                                <i class="fas fa-bars"></i>
                            </button>
                            <h3>Mensajes</h3>
                            <div class="header-actions">
                                <button class="header-icon-btn" title="Nuevo mensaje" onclick="openNewMessageModal()">
                                    <i class="fas fa-plus"></i>
                                </button>
                                <button class="header-icon-btn" title="Actualizar">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                                <button class="header-icon-btn" title="M√°s opciones">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="conversations-search">
                            <i class="fas fa-search"></i>
                            <input type="text" id="conversation-search" placeholder="Buscar conversaciones">
                        </div>
                        
                        <div class="conversations-list" id="conversations-list">
                            <!-- Conversaciones de ejemplo -->
                            <div class="conversation-item priority-alta active" onclick="selectConversation(1)">
                                <div class="conversation-avatar">
                                    <i class="fas fa-user"></i>
                                    <span class="online-indicator"></span>
                                </div>
                                <div class="conversation-info">
                                    <div class="conversation-header">
                                        <h4>Lucas Ram√≠rez (R.C)</h4>
                                        <span class="priority-badge alta">ALTA</span>
                                    </div>
                                    <p class="conversation-preview">Calificaciones 5TO C</p>
                                </div>
                                <div class="conversation-meta">
                                    <span class="conversation-time">19:48</span>
                                </div>
                            </div>
                            
                            <div class="conversation-item priority-media" onclick="selectConversation(2)">
                                <div class="conversation-avatar">
                                    <i class="fas fa-user"></i>
                                    <span class="online-indicator"></span>
                                </div>
                                <div class="conversation-info">
                                    <div class="conversation-header">
                                        <h4>Secretar√≠a</h4>
                                        <span class="priority-badge media">MEDIA</span>
                                    </div>
                                    <p class="conversation-preview">Enseguida te env√≠o los papeles.</p>
                                </div>
                                <div class="conversation-meta">
                                    <span class="conversation-time">18:30</span>
                                </div>
                            </div>
                            
                            <div class="conversation-item priority-baja" onclick="selectConversation(3)">
                                <div class="conversation-avatar">
                                    <i class="fas fa-user"></i>
                                    <span class="online-indicator"></span>
                                </div>
                                <div class="conversation-info">
                                    <div class="conversation-header">
                                        <h4>Maria Gonzalez (Docente)</h4>
                                        <span class="priority-badge baja">BAJA</span>
                                    </div>
                                    <p class="conversation-preview">Necesito reportes.</p>
                                </div>
                                <div class="conversation-meta">
                                    <span class="conversation-time">18:16</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Panel Derecho: Chat -->
                    <div class="chat-panel">
                        <div class="chat-header">
                            <div class="chat-user-info">
                                <div class="chat-avatar">
                                    <i class="fas fa-user"></i>
                                </div>
                                <div class="chat-user-details">
                                    <h3>Maria Gonzalez (Docente)</h3>
                                    <span class="user-status">En l√≠nea</span>
                                </div>
                            </div>
                            <div class="chat-header-actions">
                                <button class="header-icon-btn" title="Buscar">
                                    <i class="fas fa-search"></i>
                                </button>
                                <button class="header-icon-btn" title="M√°s opciones">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                            </div>
                        </div>

                        <div class="chat-messages" id="chat-messages">
                            <!-- Mensajes -->
                            <div class="message received">
                                <div class="message-bubble">
                                    <p>Confirmamos la reuni√≥n para ma√±ana a las 14:00</p>
                                    <span class="message-time">Ayer</span>
                                </div>
                            </div>
                            
                            <div class="message sent">
                                <div class="message-bubble">
                                    <p>Perfecto, estar√© all√≠ puntual. Gracias por confirmar</p>
                                    <span class="message-time">Ayer</span>
                                </div>
                            </div>
                        </div>

                        <div class="chat-input-container">
                            <button class="emoji-btn" title="Emojis">
                                <i class="fas fa-smile"></i>
                            </button>
                            <input type="text" class="chat-input" placeholder="Escribe un mensaje...">
                            <select class="priority-selector-input normal" id="priority-selector" title="Prioridad" onchange="updatePriorityColor(this)">
                                <option value="normal">Normal</option>
                                <option value="baja">Baja</option>
                                <option value="media">Media</option>
                                <option value="alta">Alta</option>
                            </select>
                            <button class="send-btn" title="Enviar">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Reports Section -->
            <section id="reports-section" class="section" style="display: none;">
                <div class="section-header">
                    <div class="report-filters">
                        <select id="report-period">
                            <option value="week">Esta Semana</option>
                            <option value="month">Este Mes</option>
                            <option value="quarter">Este Trimestre</option>
                            <option value="year">Este A√±o</option>
                        </select>
                        <button class="btn-primary" onclick="generateReport()">
                            <i class="fas fa-download"></i> Generar Reporte
                        </button>
                    </div>
                </div>
                <div class="reports-grid">
                    <div class="report-card">
                        <h4>Resumen de Escuelas</h4>
                        <div class="report-content" id="schools-report">
                            <!-- Contenido del reporte -->
                        </div>
                    </div>
                    <div class="report-card">
                        <h4>Resumen de Docentes</h4>
                        <div class="report-content" id="teachers-report">
                            <!-- Contenido del reporte -->
                        </div>
                    </div>
                    <div class="report-card">
                        <h4>Actividad de Mensajer√≠a</h4>
                        <div class="report-content" id="messaging-report">
                            <!-- Contenido del reporte -->
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Modal para Agregar Escuela -->
    <div id="school-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Agregar Escuela</h3>
                <button class="modal-close" onclick="closeModal('school-modal')">&times;</button>
            </div>
            <form id="school-form">
                <div class="school-form-grid">
                    <!-- Columna Izquierda -->
                    <div class="form-column">
                <div class="form-group">
                            <label for="school-nombre">Nombre de la Instituci√≥n</label>
                            <input type="text" id="school-nombre" name="nombreInstitucion" required placeholder="Ej: Escuela Primaria San Mart√≠n" maxlength="200">
                            <small>M√°ximo 200 caracteres (sin caracteres especiales)</small>
                </div>
                        
                        <fieldset class="form-fieldset">
                            <legend>Direcci√≥n</legend>
                <div class="form-group">
                                <label for="school-calle">Calle y N√∫mero</label>
                                <input type="text" id="school-calle" name="calle" required placeholder="Ej: Av. San Mart√≠n 1234" maxlength="150">
                                <small>M√°ximo 150 caracteres</small>
                </div>
                            <div class="form-inline-grid">
                <div class="form-group">
                                    <label for="school-ciudad">Ciudad</label>
                                    <input type="text" id="school-ciudad" name="ciudad" required placeholder="Ej: Buenos Aires" maxlength="150">
                </div>
                <div class="form-group">
                                    <label for="school-provincia">Provincia</label>
                                    <input type="text" id="school-provincia" name="provincia" required placeholder="Ej: Buenos Aires" maxlength="150">
                </div>
                            </div>
                        </fieldset>

                        <div class="form-group">
                            <label for="school-telefono">Tel√©fono de Contacto</label>
                            <input type="tel" id="school-telefono" name="telefonoContacto" required placeholder="Ej: +54 11 1234-5678" maxlength="30">
                            <small>Formato argentino (m√°x. 30 caracteres)</small>
                        </div>

                        <div class="form-group">
                            <label for="school-correo">Correo Institucional</label>
                            <input type="email" id="school-correo" name="correoInstitucional" required placeholder="contacto@escuela.edu.ar" maxlength="100">
                            <small>M√°ximo 100 caracteres</small>
                        </div>

                        <div class="form-group">
                            <label for="school-cue">CUE (C√≥digo √önico de Establecimiento)</label>
                            <input type="text" id="school-cue" name="cue" placeholder="Ej: 020001234" maxlength="9" pattern="[0-9]{9}">
                            <small>9 d√≠gitos num√©ricos (opcional)</small>
                        </div>
                    </div>
                    
                    <!-- Columna Derecha -->
                    <div class="form-column">
                        <div class="form-group">
                            <label for="school-nivel">Nivel Educativo</label>
                            <select id="school-nivel" name="nivelEducativo" multiple size="3" required>
                                <option value="inicial">Inicial</option>
                                <option value="primario">Primario</option>
                                <option value="secundario">Secundario</option>
                            </select>
                            <small>Mant√©n Ctrl presionado para seleccionar m√∫ltiples niveles</small>
                        </div>

                        <div class="form-group">
                            <label for="school-turnos">Turnos</label>
                            <select id="school-turnos" name="turnos" multiple size="3" required>
                                <option value="ma√±ana">Ma√±ana</option>
                                <option value="tarde">Tarde</option>
                                <option value="noche">Noche</option>
                            </select>
                            <small>Mant√©n Ctrl presionado para seleccionar m√∫ltiples turnos</small>
                        </div>

                        <div class="form-group">
                            <label for="school-estado">Estado</label>
                            <select id="school-estado" name="estado">
                                <option value="activa" selected>Activa</option>
                                <option value="inactiva">Inactiva</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="school-docentes">Cantidad de Docentes (Estimada)</label>
                            <input type="number" id="school-docentes" name="cantidadDocentes" min="0" placeholder="0">
                            <small>Campo opcional - se actualizar√° autom√°ticamente</small>
                        </div>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="closeModal('school-modal')">Cancelar</button>
                    <button type="submit" class="btn-primary">Guardar Escuela</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para Agregar Docente -->
    <div id="teacher-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Agregar Docente</h3>
                <button class="modal-close" onclick="closeModal('teacher-modal')">&times;</button>
            </div>
            <form id="teacher-form">
                <div class="teacher-form-grid">
                    <!-- Columna Izquierda -->
                    <div class="form-column">
                <div class="form-group">
                            <label for="teacher-usuario">Usuario/ID Docente</label>
                            <input type="text" id="teacher-usuario" name="usuario" required placeholder="Ej: docente001" maxlength="50" pattern="[a-zA-Z0-9_]+">
                            <small>Solo alfanum√©rico (m√°x. 50 caracteres)</small>
                </div>
                <div class="form-group">
                            <label for="teacher-nombre">Nombre</label>
                            <input type="text" id="teacher-nombre" name="nombre" required placeholder="Nombre del docente" maxlength="50">
                            <small>Solo letras (m√°x. 50 caracteres)</small>
                </div>
                <div class="form-group">
                            <label for="teacher-apellido">Apellido</label>
                            <input type="text" id="teacher-apellido" name="apellido" required placeholder="Apellido del docente" maxlength="50">
                            <small>Solo letras (m√°x. 50 caracteres)</small>
                </div>
                <div class="form-group">
                            <label for="teacher-correo">Correo Electr√≥nico</label>
                            <input type="email" id="teacher-correo" name="correo" required placeholder="correo@ejemplo.com" maxlength="100">
                            <small>M√°ximo 100 caracteres</small>
                </div>
                <div class="form-group">
                            <label for="teacher-contrase√±a">Contrase√±a</label>
                            <input type="password" id="teacher-contrase√±a" name="contrase√±a" required placeholder="Contrase√±a del docente" minlength="6" maxlength="50">
                            <small>Entre 6 y 50 caracteres</small>
                </div>
                        <div class="form-group">
                            <label for="teacher-dni">DNI</label>
                            <input type="text" id="teacher-dni" name="dni" required placeholder="12345678" pattern="[0-9]{7,10}" maxlength="10">
                            <small>Entre 7 y 10 d√≠gitos num√©ricos</small>
                        </div>
                    </div>
                    
                    <!-- Columna Derecha -->
                    <div class="form-column">
                        <div class="form-group">
                            <label for="teacher-rol">Rol</label>
                            <select id="teacher-rol" name="rol" required>
                                <option value="">Seleccionar rol</option>
                                <option value="profesor">Profesor</option>
                                <option value="maestro">Maestro</option>
                                <option value="coordinador">Coordinador</option>
                                <option value="director_academico">Director Acad√©mico</option>
                                <option value="subdirector">Subdirector</option>
                                <option value="preceptor">Preceptor</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="teacher-telefono">Tel√©fono de Contacto</label>
                            <input type="tel" id="teacher-telefono" name="telefono" required placeholder="Ej: +54 11 1234-5678" maxlength="30">
                            <small>Formato argentino (m√°x. 30 caracteres)</small>
                        </div>
                        <div class="form-group">
                            <label for="teacher-materias">Materias/Asignaturas</label>
                            <textarea id="teacher-materias" name="materias" rows="3" placeholder="Ingresa las materias separadas por comas. Ej: Matem√°ticas, F√≠sica, Qu√≠mica"></textarea>
                            <small>Separa las materias con comas</small>
                        </div>
                        <div class="form-group">
                            <label for="teacher-estado">Estado</label>
                            <select id="teacher-estado" name="estado">
                                <option value="activo" selected>Activo</option>
                                <option value="inactivo">Inactivo</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="closeModal('teacher-modal')">Cancelar</button>
                    <button type="submit" class="btn-primary">Guardar Docente</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Confirmaci√≥n de Cierre de Sesi√≥n -->
    <div id="logout-modal" class="logout-modal" style="display: none;">
        <div class="logout-modal-content">
            <div class="logout-modal-icon">
                <i class="fas fa-sign-out-alt"></i>
            </div>
            <h3>¬øCerrar sesi√≥n?</h3>
            <p>¬øEst√°s seguro de que deseas salir del sistema?</p>
            <div class="logout-modal-actions">
                <button class="btn-cancel" onclick="closeLogoutModal()">
                    Cancelar
                </button>
                <button class="btn-logout" onclick="confirmLogout()">
                    Cerrar Sesi√≥n
                </button>
            </div>
        </div>
    </div>

    <!-- Script de validaciones -->
    <script src="validaciones.js"></script>
    
    <!-- Scripts de Firebase y Autenticaci√≥n -->
    <script>
        // Configuraci√≥n de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAebJgE_34xBGfVeiLXUs9gnisoFbIPOn4",
            authDomain: "zephia-51ad4.firebaseapp.com",
            databaseURL: "https://zephia-51ad4-default-rtdb.firebaseio.com",
            projectId: "zephia-51ad4",
            storageBucket: "zephia-51ad4.firebasestorage.app",
            messagingSenderId: "829322879330",
            appId: "1:829322879330:web:f59f5389c7ead8a6440c3b",
            measurementId: "G-75CDPLDSFX"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        // Hacer disponible globalmente
        window.auth = auth;
        window.db = db;

        // Variables globales
        window.schools = [];
        window.teachers = [];
        window.currentUser = null;

        // ===== FUNCIONES GLOBALES (Definir ANTES del auth listener) =====
        
        // Funci√≥n para cerrar sesi√≥n
        window.logout = async function() {
            if (confirm('¬øEst√°s seguro de que quieres cerrar sesi√≥n?')) {
                try {
                    if (window.auth.currentUser) {
                        await window.db.collection('users').doc(window.auth.currentUser.uid).update({
                            online: false,
                            lastSeen: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }
                    
                    await window.auth.signOut();
                    window.location.href = 'login.html';
                } catch (error) {
                    console.error('Error al cerrar sesi√≥n:', error);
                    window.location.href = 'login.html';
                }
            }
        };

        // Verificar autenticaci√≥n
        auth.onAuthStateChanged(async (firebaseUser) => {
            if (!firebaseUser) {
                window.location.href = 'login.html';
                return;
            }

            try {
                // Obtener perfil del usuario
                const userDoc = await db.collection('users').doc(firebaseUser.uid).get();
                if (!userDoc.exists) {
                    console.error('Perfil de usuario no encontrado');
                    window.location.href = 'login.html';
                    return;
                }

                const userData = userDoc.data();
                window.currentUser = {
                    id: firebaseUser.uid,
                    email: firebaseUser.email,
                    name: userData.name,
                    role: userData.role,
                    schoolId: userData.schoolId,
                    schoolName: userData.schoolName
                };

                // Verificar que sea responsable
                if (userData.role !== 'responsable' && userData.role !== 'admin') {
                    console.warn('Usuario no autorizado para esta p√°gina');
                    if (userData.role === 'docente') window.location.href = 'docente.html';
                    else if (userData.role === 'secretaria') window.location.href = 'secretaria.html';
                    return;
                }

                console.log('‚úÖ Usuario autenticado:', window.currentUser);
                
                // Cargar datos
                loadData();
                
                // Inicializar sistema de mensajer√≠a
                try {
                    await window.messagingUI.initialize(window.currentUser, db);
                    console.log('üí¨ Sistema de mensajer√≠a listo');
                } catch (error) {
                    console.error('Error al inicializar mensajer√≠a:', error);
                }
            } catch (error) {
                console.error('Error al obtener perfil:', error);
                window.location.href = 'login.html';
            }
        });

        // Funciones de mensajer√≠a
        window.openNewMessageModal = function() {
            if (window.messagingUI) {
                window.messagingUI.openNewMessageModal();
            } else {
                console.warn('Sistema de mensajer√≠a no inicializado');
            }
        };
        
        window.updatePriorityColor = function(selectElement) {
            if (window.messagingUI) {
                window.messagingUI.updatePriorityColor(selectElement);
            } else {
                const value = selectElement.value;
                selectElement.classList.remove('normal', 'baja', 'media', 'alta');
                selectElement.classList.add(value);
            }
        };
        
        window.selectConversation = function(conversationId) {
            if (window.messagingUI) {
                window.messagingUI.selectConversation(conversationId);
            }
        };

        // Funci√≥n para mostrar secciones
        function showSection(sectionName) {
            const sections = document.querySelectorAll('.section');
            sections.forEach(section => section.style.display = 'none');
            
            const targetSection = document.getElementById(sectionName + '-section');
            if (targetSection) {
                targetSection.style.display = 'block';
            }
            
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                item.classList.remove('active');
                if (item.getAttribute('onclick') === `showSection('${sectionName}')`) {
                    item.classList.add('active');
                }
            });
            
            const titles = {
                dashboard: { title: 'Dashboard', desc: 'Panel del Responsable a Cargo' },
                schools: { title: 'Mis Escuelas', desc: 'Gestionar las escuelas bajo tu responsabilidad' },
                teachers: { title: 'Mis Docentes', desc: 'Gestionar los docentes de tus escuelas' },
                messaging: { title: 'Mensajer√≠a', desc: 'Comunicarte con tu equipo' },
                reports: { title: 'Reportes', desc: 'Ver estad√≠sticas y reportes' }
            };
            
            const titleInfo = titles[sectionName];
            if (titleInfo) {
                document.getElementById('section-title').textContent = titleInfo.title;
                document.getElementById('section-description').textContent = titleInfo.desc;
            }
        }

        // Funci√≥n para abrir modales
        function openModal(modalId) {
            console.log('Abriendo modal:', modalId);
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'flex';
                
                // Si es el modal de docentes, resetear el formulario
                if (modalId === 'teacher-modal') {
                    resetTeacherForm();
                }
                
                // Si es el modal de escuelas, resetear el formulario
                if (modalId === 'school-modal') {
                    resetSchoolForm();
                }
            } else {
                console.error('Modal no encontrado:', modalId);
            }
        }
        
        // Funci√≥n para cerrar modales
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        // Funci√≥n para resetear el formulario de escuelas
        function resetSchoolForm() {
            const form = document.getElementById('school-form');
            if (form) {
                form.reset();
                limpiarErroresFormulario('school-form');
            }
        }
        
        // Funci√≥n para resetear el formulario de docentes
        function resetTeacherForm() {
            const form = document.getElementById('teacher-form');
            if (form) {
                form.reset();
                limpiarErroresFormulario('teacher-form');
            }
        }

        // Funci√≥n para seleccionar conversaci√≥n
        function selectConversation(conversationId) {
            // Remover clase active de todas las conversaciones
            const conversations = document.querySelectorAll('.conversation-item');
            conversations.forEach(conv => conv.classList.remove('active'));
            
            // Agregar clase active a la conversaci√≥n seleccionada
            event.currentTarget.classList.add('active');
            
            // Aqu√≠ puedes cargar los mensajes de la conversaci√≥n seleccionada
            console.log('Conversaci√≥n seleccionada:', conversationId);
        }

        // Funci√≥n para abrir modal de nuevo mensaje
        function openNewMessageModal() {
            console.log('Abriendo modal de nuevo mensaje');
        }

        // Funci√≥n para actualizar el color del selector de prioridad
        function updatePriorityColor(selectElement) {
            const value = selectElement.value;
            // Remover todas las clases de prioridad
            selectElement.classList.remove('normal', 'baja', 'media', 'alta');
            // Agregar la clase correspondiente al valor seleccionado
            selectElement.classList.add(value);
        }

        // Funci√≥n para cargar datos
        async function loadData() {
            console.log('Cargando datos del responsable...');
            window.schools = [
                {
                    id: 'school1',
                    nombreInstitucion: 'Escuela San Mart√≠n',
                    direccion: 'Av. Principal 123',
                    telefonoContacto: '+54 11 1234-5678',
                    nivelEducativo: ['primario', 'secundario'],
                    cantidadDocentes: 15,
                    estado: 'activa'
                }
            ];
            
            window.teachers = [
                {
                    id: 'teacher1',
                    usuario: 'docente001',
                    nombre: 'Juan',
                    apellido: 'P√©rez',
                    rol: 'profesor',
                    correo: 'juan.perez@escuela.com',
                    telefono: '+54 11 9876-5432',
                    estado: 'activo'
                }
            ];
            
            updateStats();
            renderSchoolsTable();
            renderTeachersTable();
        }

        // Funci√≥n para actualizar estad√≠sticas
        function updateStats() {
            document.getElementById('total-schools').textContent = window.schools ? window.schools.length : 0;
            document.getElementById('total-teachers').textContent = window.teachers ? window.teachers.length : 0;
            document.getElementById('total-messages').textContent = '12';
            document.getElementById('total-reports').textContent = '5';
        }

        // Funci√≥n para renderizar tabla de escuelas
        function renderSchoolsTable() {
            const tbody = document.getElementById('schools-table-body');
            if (!tbody || !window.schools) return;
            
            tbody.innerHTML = '';
            window.schools.forEach(school => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${school.nombreInstitucion}</td>
                    <td>${school.direccion}</td>
                    <td>${school.telefonoContacto}</td>
                    <td>${Array.isArray(school.nivelEducativo) ? school.nivelEducativo.join(', ') : school.nivelEducativo}</td>
                    <td>${school.cantidadDocentes || 0}</td>
                    <td><span class="status-badge ${school.estado === 'activa' ? 'active' : 'inactive'}">${school.estado}</span></td>
                    <td>
                        <button class="btn-icon" title="Ver detalles">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn-icon" title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Funci√≥n para renderizar tabla de docentes
        function renderTeachersTable() {
            const tbody = document.getElementById('teachers-table-body');
            if (!tbody || !window.teachers) return;
            
            tbody.innerHTML = '';
            window.teachers.forEach(teacher => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${teacher.usuario || 'N/A'}</td>
                    <td>${teacher.nombre || ''} ${teacher.apellido || ''}</td>
                    <td><span class="role-badge ${teacher.rol || ''}">${teacher.rol || 'Sin rol'}</span></td>
                    <td>${teacher.correo || ''}</td>
                    <td>${teacher.telefono || 'N/A'}</td>
                    <td><span class="status-badge ${teacher.estado === 'activo' ? 'active' : 'inactive'}">${teacher.estado || 'activo'}</span></td>
                    <td>
                        <button class="btn-icon" title="Ver detalles">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn-icon" title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn-icon" title="Eliminar">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // ===== FUNCIONES DE B√öSQUEDA Y FILTRADO =====

        // Filtrar escuelas
        window.filterSchools = function() {
            const searchTerm = document.getElementById('schools-search').value.toLowerCase().trim();
            const tbody = document.getElementById('schools-table-body');
            
            if (!tbody || !window.schools) return;
            
            // Si no hay t√©rmino de b√∫squeda, mostrar todas
            if (!searchTerm) {
                renderSchoolsTable();
                return;
            }
            
            // Filtrar escuelas que coincidan con el t√©rmino de b√∫squeda
            const filteredSchools = window.schools.filter(school => {
                const nombre = (school.nombreInstitucion || school.name || '').toLowerCase();
                const direccion = (school.direccion || '').toLowerCase();
                const telefono = (school.telefonoContacto || school.phone || '').toLowerCase();
                const nivel = Array.isArray(school.nivelEducativo) 
                    ? school.nivelEducativo.join(' ').toLowerCase() 
                    : (school.nivelEducativo || '').toLowerCase();
                const estado = (school.estado || '').toLowerCase();
                
                return nombre.includes(searchTerm) ||
                       direccion.includes(searchTerm) ||
                       telefono.includes(searchTerm) ||
                       nivel.includes(searchTerm) ||
                       estado.includes(searchTerm);
            });
            
            // Renderizar solo las escuelas filtradas
            tbody.innerHTML = '';
            
            if (filteredSchools.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px; color: #999;">
                            <i class="fas fa-search" style="font-size: 3rem; margin-bottom: 10px; display: block;"></i>
                            No se encontraron resultados para "${searchTerm}"
                        </td>
                    </tr>
                `;
                return;
            }
            
            filteredSchools.forEach(school => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${school.nombreInstitucion}</td>
                    <td>${school.direccion}</td>
                    <td>${school.telefonoContacto}</td>
                    <td>${Array.isArray(school.nivelEducativo) ? school.nivelEducativo.join(', ') : school.nivelEducativo}</td>
                    <td>${school.cantidadDocentes || 0}</td>
                    <td><span class="status-badge ${school.estado === 'activa' ? 'active' : 'inactive'}">${school.estado}</span></td>
                    <td>
                        <button class="btn-icon" title="Ver detalles">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn-icon" title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        };

        // Filtrar docentes
        window.filterTeachers = function() {
            const searchTerm = document.getElementById('teachers-search').value.toLowerCase().trim();
            const tbody = document.getElementById('teachers-table-body');
            
            if (!tbody || !window.teachers) return;
            
            // Si no hay t√©rmino de b√∫squeda, mostrar todos
            if (!searchTerm) {
                renderTeachersTable();
                return;
            }
            
            // Filtrar docentes que coincidan con el t√©rmino de b√∫squeda
            const filteredTeachers = window.teachers.filter(teacher => {
                const usuario = (teacher.usuario || '').toLowerCase();
                const nombre = `${teacher.nombre || ''} ${teacher.apellido || ''}`.toLowerCase();
                const rol = (teacher.rol || '').toLowerCase();
                const correo = (teacher.correo || teacher.email || '').toLowerCase();
                const telefono = (teacher.telefono || '').toLowerCase();
                const estado = (teacher.estado || '').toLowerCase();
                
                return usuario.includes(searchTerm) ||
                       nombre.includes(searchTerm) ||
                       rol.includes(searchTerm) ||
                       correo.includes(searchTerm) ||
                       telefono.includes(searchTerm) ||
                       estado.includes(searchTerm);
            });
            
            // Renderizar solo los docentes filtrados
            tbody.innerHTML = '';
            
            if (filteredTeachers.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px; color: #999;">
                            <i class="fas fa-search" style="font-size: 3rem; margin-bottom: 10px; display: block;"></i>
                            No se encontraron resultados para "${searchTerm}"
                        </td>
                    </tr>
                `;
                return;
            }
            
            filteredTeachers.forEach(teacher => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${teacher.usuario || 'N/A'}</td>
                    <td>${teacher.nombre || ''} ${teacher.apellido || ''}</td>
                    <td><span class="role-badge ${teacher.rol || ''}">${teacher.rol || 'Sin rol'}</span></td>
                    <td>${teacher.correo || ''}</td>
                    <td>${teacher.telefono || 'N/A'}</td>
                    <td><span class="status-badge ${teacher.estado === 'activo' ? 'active' : 'inactive'}">${teacher.estado || 'activo'}</span></td>
                    <td>
                        <button class="btn-icon" title="Ver detalles">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn-icon" title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn-icon" title="Eliminar">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        };

        // Funci√≥n para generar reportes
        function generateReport() {
            console.log('Generando reporte...');
        }

        // Inicializar aplicaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            showSection('messaging');
            
            // Inicializar validaciones en tiempo real
            inicializarValidacionEscuelas();
            inicializarValidacionDocentes();
            
            // Event listener para el formulario de escuelas
            const schoolForm = document.getElementById('school-form');
            if (schoolForm) {
                schoolForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    // Validar formulario antes de enviar
                    if (!validarFormularioEscuela()) {
                        alert('Por favor, corrija los errores en el formulario antes de continuar');
                        return;
                    }
                    
                    alert('Escuela guardada correctamente (integraci√≥n con Firebase pendiente)');
                    closeModal('school-modal');
                    resetSchoolForm();
                });
            }
            
            // Event listener para el formulario de docentes
            const teacherForm = document.getElementById('teacher-form');
            if (teacherForm) {
                teacherForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    // Validar formulario antes de enviar
                    if (!validarFormularioDocente()) {
                        alert('Por favor, corrija los errores en el formulario antes de continuar');
                        return;
                    }
                    
                    alert('Docente guardado correctamente (integraci√≥n con Firebase pendiente)');
                    closeModal('teacher-modal');
                    resetTeacherForm();
                });
            }
        });
    </script>
</body>
</html>
